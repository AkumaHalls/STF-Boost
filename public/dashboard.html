<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STF Steam Boost - Painel</title>
    <link rel="icon" type="image/png" href="/logo.png?v=1.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css?v=1.7"> </head>
<body class="panel-page">

    <div class="dashboard-layout">
        
        <nav class="sidebar">
            <div class="sidebar-logo">
                <img src="/logo.png" alt="Logo STF Steam Boost">
                <h1 class="glitch-title" data-text="STF Boost">STF Boost</h1>
            </div>
            
            <div class="sidebar-user">
                <span id="sidebarUser">Carregando...</span>
                <span id="sidebarPlan">Plano: ...</span>
                <span id="sidebarExpiry"></span>
            </div>

            <div class="sidebar-nav">
                <span class="nav-title">Main</span>
                <a href="/">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    Home
                </a>
                <a href="/#pricing">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    Planos (Pricing)
                </a>
            </div>

            <div class="sidebar-nav">
                <span class="nav-title">Panel</span>
                <a href="/dashboard" class="active"> 
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    Painel de Controle
                </a>
            </div>

            <div class="sidebar-nav">
                <span class="nav-title">Account</span>
                <a href="#" id="activateLicenseButton">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    Ativar Licença
                </a>
                <a href="/logout" class="logout-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Logout
                </a>
            </div>
        </nav>

        <main class="main-content">
            <div class="control-panel">
                <header>
                    <div class="bulk-actions">
                        <button id="bulkStartButton" class="start-btn" disabled title="Iniciar Selecionados">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            Iniciar
                        </button>
                        <button id="bulkStopButton" class="stop-btn" disabled title="Parar Selecionados">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                            Parar
                        </button>
                        <button id="bulkRemoveButton" class="remove-btn" disabled title="Remover Selecionados">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            Remover
                        </button>
                    </div>
                    <button id="addAccountButton">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Adicionar Conta
                    </button>
                </header>
                
                <div class="accounts-table">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" title="Selecionar Todos"></th>
                                <th>Usuário</th>
                                <th>Status</th>
                                <th>Tempo Ativo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody"></tbody>
                    </table>
                </div>
            </div> 
        </main> 
    
    </div> 

    <div id="gamesModal" class="modal">
        <div class="modal-content">
            <h2>Gerir Jogos</h2>
            <input type="text" id="gameSearchInput" placeholder="Procurar jogo pelo nome...">
            <div id="gameSearchResults" class="search-results"></div>
            <p>AppIDs a serem farmados (separados por vírgula):</p>
            <textarea id="appIdsInput" rows="2" placeholder="Ex: 730, 2923300, 107410"></textarea>
            <button id="saveGamesButton">Salvar</button>
            <button id="closeGamesModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Configurações da Conta</h2>
            <div id="settingsForm">
                <div class="settings-form-row">
                    <label for="customTitleInput">Título Customizado no Jogo:</label>
                    <input type="text" id="customTitleInput" placeholder="Ex: A Farmar Horas">
                </div>
                <div class="settings-form-row">
                    <label for="customAwayMessageInput">Mensagem Automática:</label>
                    <input type="text" id="customAwayMessageInput" placeholder="Deixe em branco para desativar">
                </div>
                <div class="settings-form-row">
                    <label>Aparecer Offline:</label>
                    <label class="switch"><input type="checkbox" id="appearOfflineToggle"><span class="slider"></span></label>
                </div>
                <div class="settings-form-row">
                    <label>Aceitar Amigos Automaticamente:</label>
                    <label class="switch"><input type="checkbox" id="autoAcceptFriendsToggle"><span class="slider"></span></label>
                </div>
                <div class="settings-form-row">
                    <label>Reconectar Automaticamente:</label>
                    <label class="switch"><input type="checkbox" id="autoReloginToggle"><span class="slider"></span></label>
                </div>
                 <div class="settings-form-row">
                    <label for="sharedSecretInput">Shared Secret (TOTP):</label>
                    <input type="password" id="sharedSecretInput" placeholder="Cole aqui para automação total">
                </div>
                <div class="settings-form-row separator">
                   <label>Atualizar Credenciais</label>
                </div>
                <div class="settings-form-row">
                    <label for="newPasswordInput">Nova Senha Steam:</label>
                    <input type="password" id="newPasswordInput" placeholder="Deixe em branco para não alterar">
                </div>
            </div>
            <button id="saveSettingsButton">Salvar</button>
            <button id="closeSettingsModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="licenseModal" class="modal">
        <div class="modal-content">
            <h2>Ativar Licença</h2>
            <p>Cole a sua chave de licença abaixo para fazer upgrade do seu plano.</p>
            <input type="text" id="licenseKeyInput" placeholder="PREMIUM-XXXX-YYYY-ZZZZ">
            <button id="saveLicenseButton">Ativar</button>
            <button id="closeLicenseModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Seletores
            const accountsTableBody = document.getElementById('accountsTableBody');
            const addAccountButton = document.getElementById('addAccountButton');
            const gamesModal = document.getElementById('gamesModal');
            const closeGamesModalButton = document.getElementById('closeGamesModalButton');
            const saveGamesButton = document.getElementById('saveGamesButton');
            const appIdsInput = document.getElementById('appIdsInput');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModalButton = document.getElementById('closeSettingsModalButton');
            const saveSettingsButton = document.getElementById('saveSettingsButton');
            let currentlyEditingGamesFor = null;
            let currentlyEditingSettingsFor = null;

            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const bulkStartButton = document.getElementById('bulkStartButton');
            const bulkStopButton = document.getElementById('bulkStopButton');
            const bulkRemoveButton = document.getElementById('bulkRemoveButton');
            const gameSearchInput = document.getElementById('gameSearchInput');
            const gameSearchResults = document.getElementById('gameSearchResults');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const sidebarUser = document.getElementById('sidebarUser');
            const sidebarPlan = document.getElementById('sidebarPlan');
            const sidebarExpiry = document.getElementById('sidebarExpiry'); // *** NOVO SELETOR ***

            const licenseModal = document.getElementById('licenseModal');
            const activateLicenseButton = document.getElementById('activateLicenseButton');
            const closeLicenseModalButton = document.getElementById('closeLicenseModalButton');
            const saveLicenseButton = document.getElementById('saveLicenseButton');
            const licenseKeyInput = document.getElementById('licenseKeyInput');

            // --- Ícones (sem alterações) ---
            const icons = {
                play: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`,
                stop: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`,
                guard: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`,
                games: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>`,
                remove: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
                settings: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
                refresh: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>`
            };
            
            // --- Funções Toast e Uptime (sem alterações) ---
            function showToast(message, type = 'info') { const container = document.getElementById('toastContainer'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000); }
            function formatUptime(ms) { if (!ms || ms <= 0) return '00:00:00'; let totalSeconds = Math.floor(ms / 1000); const days = Math.floor(totalSeconds / 86400); totalSeconds %= 86400; const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0'); totalSeconds %= 3600; const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0'); const seconds = (totalSeconds % 60).toString().padStart(2, '0'); if (days > 0) { const dayString = days === 1 ? 'dia' : 'dias'; return `${days} ${dayString}, ${hours}:${minutes}:${seconds}`; } else { return `${hours}:${minutes}:${seconds}`; } }

            // --- Função fetchUserInfo (COM LÓGICA ATUALIZADA) ---
            async function fetchUserInfo() {
                try {
                    const response = await fetch('/api/user-info');
                    if (!response.ok) {
                        if (response.status === 401) window.location.href = '/login?error=unauthorized';
                        return;
                    }
                    const userInfo = await response.json();
                    
                    const planName = userInfo.plan.charAt(0).toUpperCase() + userInfo.plan.slice(1);
                    
                    sidebarUser.textContent = `Bem-vindo, ${userInfo.username}!`;
                    sidebarPlan.textContent = `Plano: ${planName}`;
                    
                    // *** INÍCIO DA LÓGICA DE EXPIRAÇÃO/HORAS ***
                    if (userInfo.plan === 'free') {
                        sidebarExpiry.textContent = `Horas restantes: ${userInfo.freeHoursRemaining}`;
                    } else if (userInfo.plan === 'lifetime') {
                        sidebarExpiry.textContent = `Plano Vitalício`;
                    } else if (userInfo.planExpiresAt) {
                        const expiryDate = new Date(userInfo.planExpiresAt);
                        const now = new Date();
                        const diffTime = expiryDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const formattedDate = expiryDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }); 

                        if (diffDays > 0) {
                            sidebarExpiry.textContent = `Expira em: ${formattedDate} (${diffDays} dias)`;
                        } else {
                            sidebarExpiry.textContent = `Expirado em: ${formattedDate}`;
                        }
                    } else {
                        // Plano pago, mas sem data (ex: mudado pelo admin para ser vitalício)
                        sidebarExpiry.textContent = `Plano Ativo (sem expiração)`;
                    }
                    // *** FIM DA LÓGICA DE EXPIRAÇÃO/HORAS ***

                } catch (e) {
                    console.error("Erro ao buscar info do usuário", e);
                    sidebarUser.textContent = 'Erro ao carregar perfil.';
                    sidebarPlan.textContent = 'Plano: Erro';
                    sidebarExpiry.textContent = '';
                }
            }

            // --- Função updateUI (sem alterações) ---
            async function updateUI() {
                const selectAllState = selectAllCheckbox.checked;
                const checkedUsernames = new Set();
                document.querySelectorAll('.account-checkbox:checked').forEach(cb => {
                    checkedUsernames.add(cb.dataset.username);
                });

                try {
                    const response = await fetch('/api/status'); 
                    if (!response.ok) { 
                        if (response.status === 401) window.location.href = '/login?error=unauthorized';
                        return; 
                    }
                    const data = await response.json();
                    const accounts = data.accounts; 
                    accountsTableBody.innerHTML = '';
                    
                    if (Object.keys(accounts).length === 0) { 
                        accountsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma conta adicionada. Clique em "Adicionar Conta" para começar.</td></tr>`; 
                    }
                    
                    for (const username in accounts) {
                        const acc = accounts[username];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="account-checkbox" data-username="${acc.username}"></td>
                            <td>${acc.username}</td>
                            <td class="status-cell">${acc.status}</td>
                            <td>${formatUptime(acc.uptime)}</td>
                            <td class="actions-cell"></td>
                        `;
                        if (checkedUsernames.has(acc.username)) {
                            const newCheckbox = row.querySelector('.account-checkbox');
                            if (newCheckbox) newCheckbox.checked = true;
                        }
                        const statusCell = row.querySelector('.status-cell');
                        statusCell.className = 'status-cell';
                        if (acc.status === 'Rodando') { statusCell.classList.add('status-running'); } 
                        else if (acc.status === 'Parado') { statusCell.classList.add('status-stopped'); } 
                        else { statusCell.classList.add('status-pending'); }
                        
                        const actionsCell = row.querySelector('.actions-cell');
                        const primaryBtn = document.createElement('button');
                        const status = acc.status;
                        if (status === 'Rodando') {
                            primaryBtn.innerHTML = icons.stop + "Parar";
                            primaryBtn.className = 'stop-btn';
                            primaryBtn.onclick = () => fetch(`/api/stop/${acc.username}`, { method: 'POST' }).finally(() => setTimeout(updateUI, 500));
                        } else if (status === 'Pendente: Steam Guard' || status.startsWith('Reconectando')) {
                            primaryBtn.innerHTML = icons.refresh + "Tentar Novamente";
                            primaryBtn.className = 'reconnect-btn';
                            primaryBtn.onclick = () => fetch(`/api/start/${acc.username}`, { method: 'POST' }).finally(() => setTimeout(updateUI, 500));
                        } else {
                            primaryBtn.innerHTML = icons.play + "Iniciar";
                            primaryBtn.className = 'start-btn';
                            primaryBtn.onclick = () => fetch(`/api/start/${acc.username}`, { method: 'POST' }).finally(() => setTimeout(updateUI, 500));
                        }
                        
                        const guardBtn = document.createElement('button');
                        guardBtn.innerHTML = icons.guard + "Guard";
                        if (acc.status === "Pendente: Steam Guard") guardBtn.classList.add('pulse-attention');
                        guardBtn.onclick = () => { const code = prompt(`Insira o código do Steam Guard para ${acc.username}:`); if (code) fetch(`/api/submit-guard/${acc.username}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code }) }).finally(() => setTimeout(updateUI, 1000)); };
                        const manageBtn = document.createElement('button');
                        manageBtn.innerHTML = icons.games + "Jogos";
                        manageBtn.onclick = () => { currentlyEditingGamesFor = acc.username; appIdsInput.value = acc.games.join(', '); gamesModal.style.display = 'block'; };
                        
                        const settingsBtn = document.createElement('button');
                        settingsBtn.innerHTML = icons.settings + "Config.";
                        settingsBtn.className = "settings-btn";
                        settingsBtn.onclick = () => {
                            currentlyEditingSettingsFor = acc.username;
                            const currentSettings = acc.settings;
                            document.getElementById('customTitleInput').value = currentSettings.customInGameTitle || '';
                            document.getElementById('customAwayMessageInput').value = currentSettings.customAwayMessage || '';
                            document.getElementById('appearOfflineToggle').checked = currentSettings.appearOffline;
                            document.getElementById('autoAcceptFriendsToggle').checked = currentSettings.autoAcceptFriends;
                            document.getElementById('autoReloginToggle').checked = currentSettings.autoRelogin;
                            document.getElementById('sharedSecretInput').value = currentSettings.sharedSecret || '';
                            settingsModal.style.display = 'block';
                        };
                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = icons.remove + "Remover";
                        removeBtn.className = "remove-btn";
                        removeBtn.onclick = () => { if (confirm(`Tem a certeza que deseja remover a conta ${acc.username}?`)) { fetch(`/api/remove-account/${acc.username}`, { method: 'DELETE' }).finally(() => setTimeout(updateUI, 500)); } };
                        
                        actionsCell.append(primaryBtn, guardBtn, manageBtn, settingsBtn, removeBtn);
                        accountsTableBody.appendChild(row);
                    }
                    selectAllCheckbox.checked = selectAllState;
                    updateBulkButtons(); 
                } catch(e) { 
                    console.error("Erro ao atualizar UI:", e);
                    accountsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Erro ao carregar dados.</td></tr>`; 
                }
            }

            // --- Lógica de Modais (sem alterações) ---
            addAccountButton.addEventListener('click', async () => { 
                const username = prompt("Nome de usuário Steam:"); 
                if (!username) return; 
                const password = prompt(`Senha para ${username}:`); 
                if (!password) return; 
                
                const response = await fetch('/api/add-account', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ username, password }) 
                }); 
                const result = await response.json(); 
                showToast(result.message, response.ok ? 'info' : 'error'); 
                updateUI(); 
            });
            let hideGamesModal = () => { 
                gamesModal.style.display = 'none'; 
                appIdsInput.value = ''; 
                currentlyEditingGamesFor = null; 
                gameSearchInput.value = '';
                gameSearchResults.innerHTML = '';
            }
            closeGamesModalButton.addEventListener('click', hideGamesModal);
            window.addEventListener('click', (event) => { if (event.target == gamesModal) hideGamesModal(); });
            saveGamesButton.addEventListener('click', async () => { 
                if (!currentlyEditingGamesFor) return; 
                const gamesArray = appIdsInput.value.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id) && id > 0); 
                
                const response = await fetch(`/api/set-games/${currentlyEditingGamesFor}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ games: gamesArray }) 
                });
                const data = await response.json();
                showToast(data.message, response.ok ? 'info' : 'error'); 
                if (response.ok) hideGamesModal(); 
            });
            let searchTimeout;
            gameSearchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const query = gameSearchInput.value;
                if (query.length < 3) {
                    gameSearchResults.innerHTML = '';
                    return;
                }
                searchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/search-game?q=${encodeURIComponent(query)}`);
                        const games = await response.json();
                        gameSearchResults.innerHTML = '';
                        games.forEach(game => {
                            const gameDiv = document.createElement('div');
                            gameDiv.className = 'search-result-item';
                            gameDiv.textContent = `${game.name} (${game.appid})`;
                            gameDiv.onclick = () => {
                                const currentIds = appIdsInput.value.split(',').map(s => s.trim()).filter(s => s);
                                if (!currentIds.includes(String(game.appid))) {
                                    currentIds.push(game.appid);
                                    appIdsInput.value = currentIds.join(', ');
                                }
                                gameSearchInput.value = '';
                                gameSearchResults.innerHTML = '';
                            };
                            gameSearchResults.appendChild(gameDiv);
                        });
                    } catch(e) { console.error("Erro ao buscar jogos", e); }
                }, 300);
            });
            let hideSettingsModal = () => { 
                settingsModal.style.display = 'none'; 
                currentlyEditingSettingsFor = null; 
                newPasswordInput.value = ''; 
            }
            closeSettingsModalButton.addEventListener('click', hideSettingsModal);
            window.addEventListener('click', (event) => { if (event.target == settingsModal) hideSettingsModal(); });
            saveSettingsButton.addEventListener('click', () => {
                if (!currentlyEditingSettingsFor) return;
                const newSettings = {
                    customInGameTitle: document.getElementById('customTitleInput').value,
                    customAwayMessage: document.getElementById('customAwayMessageInput').value,
                    appearOffline: document.getElementById('appearOfflineToggle').checked,
                    autoAcceptFriends: document.getElementById('autoAcceptFriendsToggle').checked,
                    autoRelogin: document.getElementById('autoReloginToggle').checked,
                    sharedSecret: document.getElementById('sharedSecretInput').value.trim()
                };
                const newPassword = newPasswordInput.value.trim();
                const payload = { settings: newSettings };
                if (newPassword) {
                    payload.newPassword = newPassword;
                }
                fetch(`/api/save-settings/${currentlyEditingSettingsFor}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                }).then(res => res.json()).then(data => { 
                    showToast(data.message); 
                    hideSettingsModal(); 
                });
            });
            
            // --- Lógica de Ações em Massa (sem alterações) ---
            function updateBulkButtons() {
                const selected = document.querySelectorAll('.account-checkbox:checked').length;
                bulkStartButton.disabled = selected === 0;
                bulkStopButton.disabled = selected === 0;
                bulkRemoveButton.disabled = selected === 0;
            }
            selectAllCheckbox.addEventListener('change', () => {
                document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = selectAllCheckbox.checked);
                updateBulkButtons();
            });
            accountsTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('account-checkbox')) {
                    const totalCheckboxes = document.querySelectorAll('.account-checkbox').length;
                    const checkedCheckboxes = document.querySelectorAll('.account-checkbox:checked').length;
                    selectAllCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
                    updateBulkButtons();
                }
            });
            function getSelectedUsernames() {
                return Array.from(document.querySelectorAll('.account-checkbox:checked')).map(cb => cb.dataset.username);
            }
            bulkStartButton.addEventListener('click', () => {
                const usernames = getSelectedUsernames();
                if (usernames.length === 0) return;
                fetch('/api/bulk-start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames }) })
                    .then(res => res.json()).then(data => { showToast(data.message); setTimeout(updateUI, 1000); });
            });
            bulkStopButton.addEventListener('click', () => {
                const usernames = getSelectedUsernames();
                if (usernames.length === 0) return;
                fetch('/api/bulk-stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames }) })
                    .then(res => res.json()).then(data => { showToast(data.message); setTimeout(updateUI, 1000); });
            });
            bulkRemoveButton.addEventListener('click', () => {
                const usernames = getSelectedUsernames();
                if (usernames.length === 0) return;
                if (confirm(`Tem certeza que deseja remover ${usernames.length} contas selecionadas?`)) {
                    fetch('/api/bulk-remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames }) })
                        .then(res => res.json()).then(data => { showToast(data.message); updateUI(); });
                }
            });

            // --- Lógica do Modal de Licença (sem alterações) ---
            const hideLicenseModal = () => {
                licenseModal.style.display = 'none';
                licenseKeyInput.value = '';
            }
            activateLicenseButton.addEventListener('click', (e) => {
                e.preventDefault(); 
                licenseModal.style.display = 'block';
            });
            closeLicenseModalButton.addEventListener('click', hideLicenseModal);
            window.addEventListener('click', (event) => { 
                if (event.target == licenseModal) hideLicenseModal();
            });
            saveLicenseButton.addEventListener('click', async () => {
                const licenseKey = licenseKeyInput.value.trim();
                if (!licenseKey) {
                    showToast("Por favor, insira uma chave.", 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/activate-license', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ licenseKey })
                    });
                    const result = await response.json();
                    
                    showToast(result.message, response.ok ? 'info' : 'error');
                    
                    if (response.ok) {
                        hideLicenseModal();
                        fetchUserInfo(); 
                    }
                } catch (e) {
                    showToast("Erro ao conectar ao servidor.", 'error');
                }
            });

            // --- Inicialização ---
            fetchUserInfo(); 
            updateUI(); 
            setInterval(updateUI, 1000); 
            setInterval(fetchUserInfo, 60000); // ATUALIZA O PERFIL A CADA MINUTO
        });
    </script>
</body>
</html>
