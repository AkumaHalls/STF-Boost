<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STF Steam Boost - Painel</title>
    <link rel="icon" type="image/png" href="/logo.png?v=1.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css?v=2.3"> 
</head>
<body class="panel-page">

    <div id="effectsContainer"></div>

    <div class="dashboard-layout" style="position: relative; z-index: 10;">
        
        <nav class="sidebar">
            <div class="sidebar-logo">
                <img src="/logo.png" alt="Logo">
                <h1 class="glitch-title" data-text="STF Boost">STF Boost</h1>
            </div>
            <div class="sidebar-user">
                <span id="sidebarUser">Carregando...</span>
                <span id="sidebarPlan">Plano: ...</span>
                <span id="sidebarExpiry"></span>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Main</span>
                <a href="/"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Home</a>
                <a href="/#pricing"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> Planos</a>
                <a href="/tutorial"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> Guia</a>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Panel</span>
                <a href="/dashboard" class="active"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Painel de Controle</a>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Account</span>
                <a href="#" id="myKeysButton"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg> Minhas Chaves</a>
                <a href="#" id="activateLicenseButton"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> Ativar Licen√ßa</a>
                <a href="#" id="changePasswordButton"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Mudar Senha</a>
                <a href="/logout" class="logout-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Logout</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="control-panel">
                <header>
                    <div class="bulk-actions">
                        <button id="bulkStartButton" class="start-btn" disabled title="Iniciar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Iniciar</button>
                        <button id="bulkStopButton" class="stop-btn" disabled title="Parar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> Parar</button>
                        <button id="bulkRemoveButton" class="remove-btn" disabled title="Remover"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Remover</button>
                    </div>
                    <div>
                        <button id="renewFreeButton" class="reconnect-btn" style="display: none;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Renovar Tempo</button>
                        <button id="addAccountButton"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Adicionar Conta</button>
                    </div>
                </header>
                
                <div class="accounts-table">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Usu√°rio</th>
                                <th>Status</th>
                                <th>Tempo Ativo</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody"></tbody>
                    </table>
                </div>
            </div> 
        </main> 
    </div> 

    <div id="gamesModal" class="modal">
        <div class="modal-content">
            <h2>Gerir Jogos</h2>
            <input type="text" id="gameSearchInput" placeholder="Procurar jogo pelo nome...">
            <div id="gameSearchResults" class="search-results"></div>
            <p>AppIDs a serem farmados (separados por v√≠rgula):</p>
            <textarea id="appIdsInput" rows="2" placeholder="Ex: 730, 2923300"></textarea>
            <p id="gameLimitInfo" style="color: var(--primary-color); font-weight: bold; margin-top: 5px; font-size: 14px;"></p>
            <button id="saveGamesButton">Salvar</button>
            <button id="closeGamesModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Configura√ß√µes da Conta</h2>
            <div id="settingsForm">
                <div class="settings-form-row"><label>T√≠tulo Customizado:</label><input type="text" id="customTitleInput"></div>
                <div class="settings-form-row"><label>Mensagem Autom√°tica:</label><input type="text" id="customAwayMessageInput"></div>
                <div class="settings-form-row"><label>Aparecer Offline:</label><label class="switch"><input type="checkbox" id="appearOfflineToggle"><span class="slider"></span></label></div>
                <div class="settings-form-row"><label>Aceitar Amigos:</label><label class="switch"><input type="checkbox" id="autoAcceptFriendsToggle"><span class="slider"></span></label></div>
                <div class="settings-form-row"><label>Reconectar Auto:</label><label class="switch"><input type="checkbox" id="autoReloginToggle"><span class="slider"></span></label></div>
                <div class="settings-form-row"><label>Shared Secret:</label><input type="password" id="sharedSecretInput"></div>
                <div class="settings-form-row separator"><label>Credenciais</label></div>
                <div class="settings-form-row"><label>Nova Senha:</label><input type="password" id="newPasswordInput"></div>
            </div>
            <button id="saveSettingsButton">Salvar</button>
            <button id="closeSettingsModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>
    
    <div id="licenseModal" class="modal">
        <div class="modal-content">
            <h2>Ativar Licen√ßa</h2>
            <input type="text" id="licenseKeyInput" placeholder="Chave...">
            <button id="saveLicenseButton">Ativar</button>
            <button id="closeLicenseModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>
    
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h2>Mudar Senha</h2>
            <input type="password" id="currentPasswordInput" placeholder="Atual">
            <input type="password" id="newPasswordInputModal" placeholder="Nova">
            <input type="password" id="confirmPasswordInput" placeholder="Confirmar">
            <button id="savePasswordButton">Salvar</button>
            <button id="closePasswordModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="myKeysModal" class="modal">
        <div class="modal-content">
            <h2>Minhas Chaves</h2>
            <div id="myKeysList" class="my-keys-list">A carregar...</div>
            <button id="closeMyKeysModalButton" class="remove-btn">Fechar</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Seletores e Vari√°veis
            const accountsTableBody = document.getElementById('accountsTableBody');
            const addAccountButton = document.getElementById('addAccountButton');
            const gamesModal = document.getElementById('gamesModal');
            const closeGamesModalButton = document.getElementById('closeGamesModalButton');
            const saveGamesButton = document.getElementById('saveGamesButton');
            const appIdsInput = document.getElementById('appIdsInput');
            const gameLimitInfo = document.getElementById('gameLimitInfo');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModalButton = document.getElementById('closeSettingsModalButton');
            const saveSettingsButton = document.getElementById('saveSettingsButton');
            const myKeysButton = document.getElementById('myKeysButton');
            const myKeysModal = document.getElementById('myKeysModal');
            const closeMyKeysModalButton = document.getElementById('closeMyKeysModalButton');
            const myKeysList = document.getElementById('myKeysList');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const bulkStartButton = document.getElementById('bulkStartButton');
            const bulkStopButton = document.getElementById('bulkStopButton');
            const bulkRemoveButton = document.getElementById('bulkRemoveButton');
            const gameSearchInput = document.getElementById('gameSearchInput');
            const gameSearchResults = document.getElementById('gameSearchResults');
            const sidebarUser = document.getElementById('sidebarUser');
            const sidebarPlan = document.getElementById('sidebarPlan');
            const sidebarExpiry = document.getElementById('sidebarExpiry');
            const renewFreeButton = document.getElementById('renewFreeButton');
            
            let currentlyEditingGamesFor = null;
            let currentlyEditingSettingsFor = null;
            let currentUserPlan = 'free';
            let currentUserGameLimit = 1; 

            const icons = { play: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`, stop: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`, guard: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`, games: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>`, remove: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`, settings: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`, refresh: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>` };
            function showToast(msg, type='info') { const c=document.getElementById('toastContainer'), t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),500)},4000); }
            function formatUptime(ms) { if(!ms||ms<=0)return '00:00:00'; let s=Math.floor(ms/1000), d=Math.floor(s/86400); s%=86400; let h=Math.floor(s/3600).toString().padStart(2,'0'); s%=3600; let m=Math.floor(s/60).toString().padStart(2,'0'); s=(s%60).toString().padStart(2,'0'); return d>0?`${d}d, ${h}:${m}:${s}`:`${h}:${m}:${s}`; }

            // --- EFEITOS VISUAIS (Com prote√ß√£o) ---
            let effectInterval;
            const effectsContainer = document.getElementById('effectsContainer');

            function applyThemeEffects(plan) {
                if (!effectsContainer) return; // PROTE√á√ÉO CONTRA ERRO
                effectsContainer.innerHTML = '';
                if (effectInterval) clearInterval(effectInterval);
                let symbol = '', className = '', intervalTime = 500;
                
                if (plan === 'halloween') { symbol = 'ü¶á'; className = 'bat'; intervalTime = 800; }
                else if (plan === 'christmas') { symbol = '‚ùÑÔ∏è'; className = 'snow'; intervalTime = 300; }
                else if (plan === 'newyear') { symbol = '‚ú®'; className = 'sparkle'; intervalTime = 600; }
                else return; 
                
                effectInterval = setInterval(() => {
                    const p = document.createElement('div'); p.className = `particle ${className}`; p.textContent = symbol; p.style.left = Math.random() * 100 + 'vw';
                    const size = Math.random() * 20 + 10; p.style.fontSize = size + 'px';
                    const duration = Math.random() * 3 + 2; p.style.animationDuration = duration + 's';
                    effectsContainer.appendChild(p);
                    setTimeout(() => p.remove(), duration * 1000);
                }, intervalTime);
            }

            // --- Fetch User Info ---
            async function fetchUserInfo() {
                try {
                    const res = await fetch('/api/user-info');
                    if (!res.ok) { if (res.status === 401) window.location.href = '/login?error=unauthorized'; return; }
                    const data = await res.json();
                    
                    const planName = data.plan.charAt(0).toUpperCase() + data.plan.slice(1);
                    if(sidebarUser) sidebarUser.textContent = `Bem-vindo, ${data.username}!`;
                    if(sidebarPlan) sidebarPlan.textContent = `Plano: ${planName}`;
                    
                    if (currentUserPlan !== data.plan) applyThemeEffects(data.plan);
                    currentUserPlan = data.plan;
                    currentUserGameLimit = data.gameLimit; 

                    const exp = document.getElementById('sidebarExpiry');
                    const btn = document.getElementById('renewFreeButton');
                    if (btn) btn.style.display = 'none';
                    if (exp) exp.textContent = '';

                    if (data.plan === 'free') {
                        if(exp) exp.textContent = `Horas: ${data.freeHoursRemaining}`;
                        if (data.freeHoursRemaining <= 0 && btn) btn.style.display = 'inline-flex';
                    } else if (data.plan === 'lifetime') {
                        if(exp) exp.textContent = `Plano Vital√≠cio`;
                    } else if (data.planExpiresAt) {
                        const expiryDate = new Date(data.planExpiresAt);
                        const now = new Date();
                        const diffDays = Math.ceil((expiryDate - now) / (86400000));
                        const formattedDate = expiryDate.toLocaleDateString('pt-BR'); 
                        if(exp) exp.textContent = diffDays > 0 ? `Expira em: ${formattedDate} (${diffDays} dias)` : `Expirado em: ${formattedDate}`;
                    } else {
                        if(exp) exp.textContent = `Plano Ativo`;
                    }
                } catch (e) { console.error("Erro fetchUserInfo:", e); }
            }

            async function updateUI() {
                try {
                    const res = await fetch('/api/status');
                    if (!res.ok) { if (res.status === 401) window.location.href = '/login?error=unauthorized'; return; }
                    const data = await res.json();
                    accountsTableBody.innerHTML = '';
                    if (Object.keys(data.accounts).length === 0) { accountsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma conta adicionada.</td></tr>`; return; }
                    
                    const selectAllState = selectAllCheckbox ? selectAllCheckbox.checked : false;
                    const checkedUsernames = new Set();
                    document.querySelectorAll('.account-checkbox:checked').forEach(cb => checkedUsernames.add(cb.dataset.username));

                    for (const u in data.accounts) {
                        const acc = data.accounts[u];
                        const row = document.createElement('tr');
                        row.innerHTML = `<td><input type="checkbox" class="account-checkbox" data-username="${acc.username}"></td><td>${acc.username}</td><td class="${acc.status === 'Rodando' ? 'status-running' : 'status-stopped'}">${acc.status}</td><td>${formatUptime(acc.uptime)}</td><td class="actions-cell"></td>`;
                        if (checkedUsernames.has(acc.username)) row.querySelector('.account-checkbox').checked = true;
                        const actions = row.querySelector('.actions-cell');
                        
                        const btnStart = document.createElement('button');
                        if(acc.status==='Rodando'){ btnStart.innerHTML=icons.stop+"Parar"; btnStart.className='stop-btn'; btnStart.onclick=()=>fetch(`/api/stop/${acc.username}`,{method:'POST'}).then(updateUI); }
                        else { btnStart.innerHTML=icons.play+"Iniciar"; btnStart.className='start-btn'; btnStart.onclick=()=>fetch(`/api/start/${acc.username}`,{method:'POST'}).then(res=>res.json()).then(d=>{showToast(d.message, res.ok?'info':'error'); updateUI();}); }
                        
                        const btnGuard = document.createElement('button'); btnGuard.innerHTML=icons.guard+"Guard"; if (acc.status === "Pendente: Steam Guard") btnGuard.classList.add('pulse-attention'); btnGuard.onclick=()=>{const c=prompt('C√≥digo:');if(c)fetch(`/api/submit-guard/${acc.username}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:c})});};
                        const btnGames = document.createElement('button'); btnGames.innerHTML=icons.games+"Jogos"; btnGames.onclick=()=>{ currentlyEditingGamesFor=acc.username; appIdsInput.value=acc.games.join(', '); gamesModal.style.display='block'; updateGameLimitText(); };
                        
                        const btnSettings = document.createElement('button'); btnSettings.innerHTML=icons.settings+"Config"; btnSettings.className="settings-btn";
                        btnSettings.onclick=()=>{ 
                            currentlyEditingSettingsFor=acc.username;
                            const s=acc.settings;
                            document.getElementById('customTitleInput').value=s.customInGameTitle||'';
                            document.getElementById('customAwayMessageInput').value=s.customAwayMessage||'';
                            document.getElementById('appearOfflineToggle').checked=s.appearOffline;
                            document.getElementById('autoAcceptFriendsToggle').checked=s.autoAcceptFriends;
                            document.getElementById('autoReloginToggle').checked=s.autoRelogin;
                            document.getElementById('sharedSecretInput').value=s.sharedSecret||'';
                            
                            const els = ['customTitleInput','customAwayMessageInput','appearOfflineToggle','autoAcceptFriendsToggle'];
                            els.forEach(id=>document.getElementById(id).disabled=false);
                            if(currentUserPlan==='free') els.forEach(id=>document.getElementById(id).disabled=true);
                            else if(currentUserPlan==='basic') document.getElementById('autoAcceptFriendsToggle').disabled=true;
                            
                            settingsModal.style.display='block';
                        };
                        const btnDel = document.createElement('button'); btnDel.innerHTML=icons.remove+"Remover"; btnDel.className="remove-btn"; btnDel.onclick=()=>{if(confirm('Remover?'))fetch(`/api/remove-account/${acc.username}`,{method:'DELETE'}).then(updateUI);};

                        actions.append(btnStart, btnGuard, btnGames, btnSettings, btnDel);
                        accountsTableBody.appendChild(row);
                    }
                    if(selectAllCheckbox) selectAllCheckbox.checked = selectAllState;
                    updateBulkButtons();
                } catch(e){}
            }

            function updateGameLimitText() {
                const c = appIdsInput.value.split(',').filter(id => id.trim() !== '').length;
                gameLimitInfo.textContent = `Jogos selecionados: ${c} / ${currentUserGameLimit}`;
                gameLimitInfo.style.color = c > currentUserGameLimit ? '#ff6B6B' : '#00ffff';
            }
            appIdsInput.addEventListener('input', updateGameLimitText);

            addAccountButton.addEventListener('click', async () => {
                const u = prompt("User Steam:"); if(!u)return;
                const p = prompt("Senha:"); if(!p)return;
                const res = await fetch('/api/add-account', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                const d = await res.json(); showToast(d.message, res.ok?'info':'error'); updateUI();
            });

            // Modais
            const hideGamesModal = () => { gamesModal.style.display='none'; };
            document.getElementById('closeGamesModalButton').onclick = hideGamesModal;
            saveGamesButton.onclick = async () => {
                const games = appIdsInput.value.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n));
                const res = await fetch(`/api/set-games/${currentlyEditingGamesFor}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({games})});
                const d = await res.json(); showToast(d.message, res.ok?'info':'error');
                if(res.ok) hideGamesModal();
            };

            const hideSettingsModal = () => { settingsModal.style.display = 'none'; currentlyEditingSettingsFor = null; }
            closeSettingsModalButton.addEventListener('click', hideSettingsModal);
            window.addEventListener('click', (event) => { if (event.target == settingsModal) hideSettingsModal(); });
            saveSettingsButton.addEventListener('click', () => {
                if (!currentlyEditingSettingsFor) return;
                const s = {
                    customInGameTitle: document.getElementById('customTitleInput').value,
                    customAwayMessage: document.getElementById('customAwayMessageInput').value,
                    appearOffline: document.getElementById('appearOfflineToggle').checked,
                    autoAcceptFriends: document.getElementById('autoAcceptFriendsToggle').checked,
                    autoRelogin: document.getElementById('autoReloginToggle').checked,
                    sharedSecret: document.getElementById('sharedSecretInput').value.trim()
                };
                const p = document.getElementById('newPasswordInput').value.trim();
                const payload = { settings: s }; if (p) payload.newPassword = p;
                fetch(`/api/save-settings/${currentlyEditingSettingsFor}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(res => res.json()).then(data => { showToast(data.message, data.ok !== false ? 'info' : 'error'); if (data.ok !== false) hideSettingsModal(); });
            });

            // Search Game
            let searchTimeout;
            gameSearchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                if(gameSearchInput.value.length<3) { gameSearchResults.innerHTML=''; return; }
                searchTimeout = setTimeout(async()=>{
                    const res = await fetch(`/api/search-game?q=${gameSearchInput.value}`);
                    const data = await res.json();
                    gameSearchResults.innerHTML='';
                    data.forEach(g=>{
                        const d=document.createElement('div'); d.className='search-result-item'; d.textContent=`${g.name} (${g.appid})`;
                        d.onclick=()=>{ 
                            const ids=appIdsInput.value.split(',').map(s=>s.trim()).filter(s=>s);
                            if(!ids.includes(String(g.appid))) { ids.push(g.appid); appIdsInput.value=ids.join(', '); updateGameLimitText(); }
                            gameSearchInput.value=''; gameSearchResults.innerHTML='';
                        };
                        gameSearchResults.appendChild(d);
                    })
                },300);
            });

            function updateBulkButtons() {
                if (!selectAllCheckbox) return;
                const selected = document.querySelectorAll('.account-checkbox:checked').length;
                bulkStartButton.disabled = selected === 0;
                bulkStopButton.disabled = selected === 0;
                bulkRemoveButton.disabled = selected === 0;
            }
            if(selectAllCheckbox) selectAllCheckbox.addEventListener('change', () => { document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = selectAllCheckbox.checked); updateBulkButtons(); });
            accountsTableBody.addEventListener('change', (e) => { if (e.target.classList.contains('account-checkbox')) updateBulkButtons(); });
            const getSel = () => Array.from(document.querySelectorAll('.account-checkbox:checked')).map(cb => cb.dataset.username);
            if(bulkStartButton) bulkStartButton.onclick = () => fetch('/api/bulk-start', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usernames:getSel()})}).then(r=>r.json()).then(d=>{showToast(d.message);setTimeout(updateUI,1000)});
            if(bulkStopButton) bulkStopButton.onclick = () => fetch('/api/bulk-stop', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usernames:getSel()})}).then(r=>r.json()).then(d=>{showToast(d.message);setTimeout(updateUI,1000)});
            if(bulkRemoveButton) bulkRemoveButton.onclick = () => { if(confirm('Remover?')) fetch('/api/bulk-remove', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usernames:getSel()})}).then(r=>r.json()).then(d=>{showToast(d.message);updateUI()}); };

            // Modais Extras
            const licenseModal = document.getElementById('licenseModal');
            const licenseKeyInput = document.getElementById('licenseKeyInput');
            document.getElementById('activateLicenseButton').onclick = (e) => { e.preventDefault(); licenseModal.style.display = 'block'; };
            document.getElementById('closeLicenseModalButton').onclick = () => licenseModal.style.display = 'none';
            document.getElementById('saveLicenseButton').onclick = async () => {
                const key = licenseKeyInput.value.trim();
                if(!key) return showToast('Insira a chave.', 'error');
                const res = await fetch('/api/activate-license', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({licenseKey:key})});
                const d = await res.json(); showToast(d.message, res.ok?'info':'error');
                if(res.ok) { licenseModal.style.display = 'none'; fetchUserInfo(); }
            };

            const passwordModal = document.getElementById('passwordModal');
            document.getElementById('changePasswordButton').onclick = (e) => { e.preventDefault(); passwordModal.style.display = 'block'; };
            document.getElementById('closePasswordModalButton').onclick = () => passwordModal.style.display = 'none';
            document.getElementById('savePasswordButton').onclick = async () => {
                const cur = document.getElementById('currentPasswordInput').value;
                const newP = document.getElementById('newPasswordInputModal').value;
                const conf = document.getElementById('confirmPasswordInput').value;
                const res = await fetch('/api/change-password', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({currentPassword:cur, newPassword:newP, confirmPassword:conf})});
                const d = await res.json(); showToast(d.message, res.ok?'info':'error');
                if(res.ok) passwordModal.style.display = 'none';
            };

            myKeysButton.onclick = async (e) => {
                e.preventDefault(); myKeysModal.style.display = 'block';
                try {
                    const res = await fetch('/api/my-keys'); const keys = await res.json();
                    if(keys.length === 0) myKeysList.innerHTML = '<p>Sem chaves.</p>';
                    else {
                        myKeysList.innerHTML = '';
                        keys.forEach(k => {
                            const d = document.createElement('div'); d.className = 'my-key-item';
                            d.innerHTML = `<strong>${k.plan}</strong><span>${k.durationDays ? k.durationDays + ' dias' : 'Vital√≠cia'}</span><input type="text" value="${k.key}" readonly>`;
                            myKeysList.appendChild(d);
                        });
                    }
                } catch(e) { myKeysList.innerHTML = '<p>Erro.</p>'; }
            };
            closeMyKeysModalButton.onclick = () => myKeysModal.style.display = 'none';
            window.onclick = (e) => { if ([gamesModal, settingsModal, licenseModal, passwordModal, myKeysModal].includes(e.target)) e.target.style.display='none'; };

            fetchUserInfo();
            updateUI();
            setInterval(updateUI, 1000);
            setInterval(fetchUserInfo, 60000);
        });
    </script>
</body>
</html>
