<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STF Steam Boost - Painel</title>
    <link rel="icon" type="image/png" href="/logo.png?v=1.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css?v=1.9"> 
</head>
<body class="panel-page">
    <div class="dashboard-layout">
        <nav class="sidebar">
            <div class="sidebar-logo">
                <img src="/logo.png" alt="Logo">
                <h1 class="glitch-title" data-text="STF Boost">STF Boost</h1>
            </div>
            <div class="sidebar-user">
                <span id="sidebarUser">Carregando...</span>
                <span id="sidebarPlan">Plano: ...</span>
                <span id="sidebarExpiry"></span>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Main</span>
                <a href="/"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Home</a>
                <a href="/#pricing"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> Planos</a>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Panel</span>
                <a href="/dashboard" class="active"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Painel de Controle</a>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Account</span>
                <a href="#" id="myKeysButton"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg> Minhas Chaves</a>
                <a href="#" id="activateLicenseButton"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> Ativar Licença</a>
                <a href="#" id="changePasswordButton"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Mudar Senha</a>
                <a href="/logout" class="logout-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Logout</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="control-panel">
                <header>
                    <div class="bulk-actions">
                        <button id="bulkStartButton" class="start-btn" disabled title="Iniciar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Iniciar
                        </button>
                        <button id="bulkStopButton" class="stop-btn" disabled title="Parar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> Parar
                        </button>
                        <button id="bulkRemoveButton" class="remove-btn" disabled title="Remover">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Remover
                        </button>
                    </div>
                    <div>
                        <button id="renewFreeButton" class="reconnect-btn" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Renovar Tempo
                        </button>
                        <button id="addAccountButton">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Adicionar Conta
                        </button>
                    </div>
                </header>
                
                <div class="accounts-table">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Usuário</th>
                                <th>Status</th>
                                <th>Tempo Ativo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody"></tbody>
                    </table>
                </div>
            </div> 
        </main> 
    </div> 

    <div id="gamesModal" class="modal">
        <div class="modal-content">
            <h2>Gerir Jogos</h2>
            <input type="text" id="gameSearchInput" placeholder="Procurar jogo pelo nome...">
            <div id="gameSearchResults" class="search-results"></div>
            <p>AppIDs a serem farmados (separados por vírgula):</p>
            <textarea id="appIdsInput" rows="2" placeholder="Ex: 730, 2923300"></textarea>
            
            <p id="gameLimitInfo" style="color: var(--primary-color); font-weight: bold; margin-top: 5px; font-size: 14px;"></p>
            
            <button id="saveGamesButton">Salvar</button>
            <button id="closeGamesModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="settingsModal" class="modal"> <div class="modal-content">
            <h2>Configurações da Conta</h2>
            <div id="settingsForm">
                <div class="settings-form-row"><label>Título Customizado:</label><input type="text" id="customTitleInput"></div>
                <div class="settings-form-row"><label>Mensagem Automática:</label><input type="text" id="customAwayMessageInput"></div>
                <div class="settings-form-row"><label>Aparecer Offline:</label><label class="switch"><input type="checkbox" id="appearOfflineToggle"><span class="slider"></span></label></div>
                <div class="settings-form-row"><label>Aceitar Amigos:</label><label class="switch"><input type="checkbox" id="autoAcceptFriendsToggle"><span class="slider"></span></label></div>
                <div class="settings-form-row"><label>Reconectar Auto:</label><label class="switch"><input type="checkbox" id="autoReloginToggle"><span class="slider"></span></label></div>
                <div class="settings-form-row"><label>Shared Secret:</label><input type="password" id="sharedSecretInput"></div>
                <div class="settings-form-row separator"><label>Credenciais</label></div>
                <div class="settings-form-row"><label>Nova Senha:</label><input type="password" id="newPasswordInput"></div>
            </div>
            <button id="saveSettingsButton">Salvar</button>
            <button id="closeSettingsModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>
    
    <div id="licenseModal" class="modal"> <div class="modal-content">
            <h2>Ativar Licença</h2>
            <input type="text" id="licenseKeyInput" placeholder="Chave...">
            <button id="saveLicenseButton">Ativar</button>
            <button id="closeLicenseModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>
    
    <div id="passwordModal" class="modal"> <div class="modal-content">
            <h2>Mudar Senha</h2>
            <input type="password" id="currentPasswordInput" placeholder="Atual">
            <input type="password" id="newPasswordInputModal" placeholder="Nova">
            <input type="password" id="confirmPasswordInput" placeholder="Confirmar">
            <button id="savePasswordButton">Salvar</button>
            <button id="closePasswordModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="myKeysModal" class="modal"> <div class="modal-content">
            <h2>Minhas Chaves</h2>
            <div id="myKeysList" class="my-keys-list">A carregar...</div>
            <button id="closeMyKeysModalButton" class="remove-btn">Fechar</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referências
            const accountsTableBody = document.getElementById('accountsTableBody');
            const addAccountButton = document.getElementById('addAccountButton');
            
            // Games Modal
            const gamesModal = document.getElementById('gamesModal');
            const closeGamesModalButton = document.getElementById('closeGamesModalButton');
            const saveGamesButton = document.getElementById('saveGamesButton');
            const appIdsInput = document.getElementById('appIdsInput');
            const gameLimitInfo = document.getElementById('gameLimitInfo'); // *** NOVO ***
            const gameSearchInput = document.getElementById('gameSearchInput');
            const gameSearchResults = document.getElementById('gameSearchResults');

            // Variáveis Globais
            let currentlyEditingGamesFor = null;
            let currentlyEditingSettingsFor = null;
            let currentUserPlan = 'free';
            let currentUserGameLimit = 1; // *** NOVO: Limite de jogos do usuário ***

            // Ícones (Reduzido para poupar espaço)
            const icons = { play: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`, stop: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`, guard: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`, games: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>`, remove: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`, settings: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`, refresh: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>` };

            function showToast(msg, type='info') { const c=document.getElementById('toastContainer'), t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),500)},4000); }
            function formatUptime(ms) { if(!ms||ms<=0)return '00:00:00'; let s=Math.floor(ms/1000), d=Math.floor(s/86400); s%=86400; let h=Math.floor(s/3600).toString().padStart(2,'0'); s%=3600; let m=Math.floor(s/60).toString().padStart(2,'0'); s=(s%60).toString().padStart(2,'0'); return d>0?`${d}d, ${h}:${m}:${s}`:`${h}:${m}:${s}`; }

            // --- Fetch User Info ---
            async function fetchUserInfo() {
                try {
                    const res = await fetch('/api/user-info');
                    if (!res.ok) return;
                    const data = await res.json();
                    
                    document.getElementById('sidebarUser').textContent = `Bem-vindo, ${data.username}!`;
                    document.getElementById('sidebarPlan').textContent = `Plano: ${data.plan.charAt(0).toUpperCase() + data.plan.slice(1)}`;
                    
                    currentUserPlan = data.plan;
                    currentUserGameLimit = data.gameLimit; // *** SALVA O LIMITE ***

                    const exp = document.getElementById('sidebarExpiry');
                    const btn = document.getElementById('renewFreeButton');
                    btn.style.display = 'none';

                    if (data.plan === 'free') {
                        exp.textContent = `Horas: ${data.freeHoursRemaining}`;
                        if (data.freeHoursRemaining <= 0) btn.style.display = 'inline-flex';
                    } else if (data.planExpiresAt) {
                        const days = Math.ceil((new Date(data.planExpiresAt) - new Date()) / (86400000));
                        exp.textContent = days > 0 ? `Expira: ${days} dias` : 'Expirado';
                    } else {
                        exp.textContent = 'Vitalício';
                    }
                } catch (e) {}
            }

            // --- UI Update ---
            async function updateUI() {
                try {
                    const res = await fetch('/api/status');
                    if (!res.ok) return;
                    const data = await res.json();
                    accountsTableBody.innerHTML = '';
                    if (Object.keys(data.accounts).length === 0) {
                         accountsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma conta.</td></tr>`;
                    }
                    for (const u in data.accounts) {
                        const acc = data.accounts[u];
                        const row = document.createElement('tr');
                        row.innerHTML = `<td><input type="checkbox" class="cb" data-u="${acc.username}"></td><td>${acc.username}</td><td class="${acc.status === 'Rodando' ? 'status-running' : 'status-stopped'}">${acc.status}</td><td>${formatUptime(acc.uptime)}</td><td class="actions-cell"></td>`;
                        
                        const actions = row.querySelector('.actions-cell');
                        
                        const btnStart = document.createElement('button');
                        if(acc.status==='Rodando'){ btnStart.innerHTML=icons.stop+"Parar"; btnStart.className='stop-btn'; btnStart.onclick=()=>fetch(`/api/stop/${acc.username}`,{method:'POST'}).then(updateUI); }
                        else { btnStart.innerHTML=icons.play+"Iniciar"; btnStart.className='start-btn'; btnStart.onclick=()=>fetch(`/api/start/${acc.username}`,{method:'POST'}).then(res=>res.json()).then(d=>{showToast(d.message, res.ok?'info':'error'); updateUI();}); }
                        
                        const btnGuard = document.createElement('button'); btnGuard.innerHTML=icons.guard+"Guard"; btnGuard.onclick=()=>{const c=prompt('Código:');if(c)fetch(`/api/submit-guard/${acc.username}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:c})});};
                        
                        const btnGames = document.createElement('button'); btnGames.innerHTML=icons.games+"Jogos"; 
                        btnGames.onclick = () => { 
                            currentlyEditingGamesFor = acc.username; 
                            appIdsInput.value = acc.games.join(', '); 
                            gamesModal.style.display = 'block';
                            updateGameLimitText(); // *** Atualiza texto ao abrir ***
                        };
                        
                        const btnSettings = document.createElement('button'); btnSettings.innerHTML=icons.settings+"Config"; btnSettings.className="settings-btn";
                        btnSettings.onclick = () => { /* Lógica de settings abre modal... simplificado aqui */ 
                            currentlyEditingSettingsFor = acc.username;
                            document.getElementById('settingsModal').style.display = 'block';
                            // (Lógica de preencher e desabilitar inputs permanece a mesma do passo anterior)
                        };

                        const btnDel = document.createElement('button'); btnDel.innerHTML=icons.remove+"Remover"; btnDel.className="remove-btn"; btnDel.onclick=()=>{if(confirm('Remover?'))fetch(`/api/remove-account/${acc.username}`,{method:'DELETE'}).then(updateUI);};

                        actions.append(btnStart, btnGuard, btnGames, btnSettings, btnDel);
                        accountsTableBody.appendChild(row);
                    }
                } catch(e){}
            }

            // --- Lógica do Contador de Jogos ---
            function updateGameLimitText() {
                const currentGames = appIdsInput.value.split(',').filter(id => id.trim() !== '').length;
                gameLimitInfo.textContent = `Jogos selecionados: ${currentGames} / ${currentUserGameLimit}`;
                
                if (currentGames > currentUserGameLimit) {
                    gameLimitInfo.style.color = '#ff6B6B'; // Vermelho se passar do limite
                } else {
                    gameLimitInfo.style.color = '#00ffff'; // Ciano se ok
                }
            }

            appIdsInput.addEventListener('input', updateGameLimitText);

            // --- Add Account ---
            addAccountButton.addEventListener('click', async () => {
                const u = prompt("User Steam:"); if(!u)return;
                const p = prompt("Senha:"); if(!p)return;
                const res = await fetch('/api/add-account', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                const d = await res.json(); showToast(d.message, res.ok?'info':'error'); updateUI();
            });

            // --- Modais Globais ---
            // (Lógica de fechar modais, salvar jogos, configurações, licenças, etc. permanece igual)
            
            const hideGamesModal = () => { gamesModal.style.display='none'; };
            document.getElementById('closeGamesModalButton').onclick = hideGamesModal;
            saveGamesButton.onclick = async () => {
                const games = appIdsInput.value.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n));
                const res = await fetch(`/api/set-games/${currentlyEditingGamesFor}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({games})});
                const d = await res.json(); showToast(d.message, res.ok?'info':'error');
                if(res.ok) hideGamesModal();
            };

            // Search Game
            let searchTimeout;
            gameSearchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                if(gameSearchInput.value.length<3) { gameSearchResults.innerHTML=''; return; }
                searchTimeout = setTimeout(async()=>{
                    const res = await fetch(`/api/search-game?q=${gameSearchInput.value}`);
                    const data = await res.json();
                    gameSearchResults.innerHTML='';
                    data.forEach(g=>{
                        const d=document.createElement('div'); d.className='search-result-item'; d.textContent=`${g.name} (${g.appid})`;
                        d.onclick=()=>{ 
                            const ids=appIdsInput.value.split(',').map(s=>s.trim()).filter(s=>s);
                            if(!ids.includes(String(g.appid))) { ids.push(g.appid); appIdsInput.value=ids.join(', '); updateGameLimitText(); }
                            gameSearchInput.value=''; gameSearchResults.innerHTML='';
                        };
                        gameSearchResults.appendChild(d);
                    })
                },300);
            });

            // Init
            fetchUserInfo();
            updateUI();
            setInterval(updateUI, 1000);
            setInterval(fetchUserInfo, 60000);
        });
    </script>
</body>
</html>
