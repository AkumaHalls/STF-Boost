<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - STF Boost</title>
    <link rel="icon" type="image/png" href="/logo.png?v=1.1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css?v=2.3">
    <style>
        .tech-font { font-family: 'Share Tech Mono', monospace; }
        .global-alert { position: absolute; top: 0; left: 0; width: 100%; }
        /* Correção para garantir que o estilo do style.css não quebre o Tailwind */
        .login-box input { margin-bottom: 0; } 
    </style>
</head>
<body class="panel-page login-page">

    <div id="globalAlert" class="global-alert" style="display: none;">
        <span id="globalAlertMessage"></span>
        <button class="alert-close" onclick="closeGlobalAlert()">×</button>
    </div>

    <div class="login-box" style="margin-top: 60px;"> 
        <div class="sidebar-logo" style="justify-content: center; padding-bottom: 20px; border-bottom: none;">
            <img src="/logo.png" alt="Logo STF Steam Boost">
            <h1 class="glitch-title" data-text="STF Boost">STF Boost</h1>
        </div>
        
        <h2 class="text-xl text-center text-white tech-font mb-6">Acessar Painel</h2>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <form id="loginForm" class="space-y-6">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-300 text-left mb-1">Usuário</label>
                <input type="text" id="username" name="username" required 
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-300 text-left mb-1">Senha</label>
                <input type="password" id="password" name="password" required 
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono">
            </div>
            
            <button type="submit" id="submitButton" 
                class="w-full px-4 py-3 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors tech-font uppercase tracking-wider shadow-lg shadow-blue-900/50">
                Entrar
            </button>
        </form>

        <p class="text-sm text-center text-gray-400 mt-6">
            Não tem uma conta? 
            <a href="/register" class="font-medium text-blue-400 hover:underline">Registre-se aqui</a>
        </p>
    </div>

    <script>
        // --- LÓGICA DO ALERTA GLOBAL ---
        async function checkGlobalAlert() {
            try {
                const res = await fetch('/api/global-alert');
                const data = await res.json();
                
                if (data && data.active) {
                    const lastClosed = localStorage.getItem('globalAlertClosed');
                    if (lastClosed !== data.updatedAt) {
                        const el = document.getElementById('globalAlert');
                        el.className = `global-alert alert-${data.type}`; 
                        document.getElementById('globalAlertMessage').textContent = data.message;
                        el.style.display = 'block';
                        el.dataset.updatedAt = data.updatedAt; 
                    }
                }
            } catch(e) { console.error("Erro ao carregar alerta:", e); }
        }

        window.closeGlobalAlert = function() {
            const el = document.getElementById('globalAlert');
            el.style.display = 'none';
            if (el.dataset.updatedAt) {
                localStorage.setItem('globalAlertClosed', el.dataset.updatedAt);
            }
        };

        // --- LÓGICA DE LOGIN ---
        document.addEventListener('DOMContentLoaded', () => {
            checkGlobalAlert();

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'unauthorized') {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Você precisa fazer login para acessar essa página.';
                errorMessage.style.display = 'block';
            }

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const submitButton = document.getElementById('submitButton');
                const errorMessage = document.getElementById('errorMessage');

                submitButton.disabled = true;
                submitButton.textContent = 'AGUARDE...';
                errorMessage.style.display = 'none';

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.message || 'Erro desconhecido');
                    window.location.href = '/dashboard';

                } catch (error) {
                    errorMessage.textContent = error.message;
                    errorMessage.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.textContent = 'ENTRAR';
                }
            });
        });
    </script>
</body>
</html>
