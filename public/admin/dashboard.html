<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - STF Boost</title>
    <link rel="icon" type="image/png" href="/logo.png?v=1.1">
    <link rel="stylesheet" href="/style.css?v=2.0"> 
</head>
<body class="panel-page">
    <div class="dashboard-layout">
        <nav class="sidebar">
            <div class="sidebar-logo">
                <img src="/logo.png" alt="Logo">
                <h1 class="glitch-title" data-text="ADMIN">ADMIN</h1>
            </div>
            <div class="sidebar-user">
                <span id="sidebarUser">Painel de Admin</span>
                <span id="sidebarPlan" style="margin-top: 4px;">Controlo Total</span>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Gestão</span>
                <a href="/admin/dashboard" class="active"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> Usuários e Licenças</a>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Site</span>
                <a href="/"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Ver Landing Page</a>
                <a href="/admin/logout" class="logout-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Logout</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="admin-container">
                
                <div class="admin-card">
                    <h2>Gerador de Licenças</h2>
                    <div class="admin-form">
                        <label for="planSelect">Plano:</label>
                        <select id="planSelect">
                            </select>
                        <label for="quantityInput">Qtd:</label>
                        <input type="number" id="quantityInput" value="1" min="1" max="50">
                        <label for="durationInput">Dias:</label>
                        <input type="number" id="durationInput" placeholder="Padrão do plano">
                        <button id="generateKeysButton">Gerar</button>
                    </div>
                    <div id="generatedKeys"><pre id="keysOutput"></pre></div>
                </div>

                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Gestão de Planos</h2>
                        <button id="addPlanButton" class="assign-key-btn">Criar Novo Plano</button>
                    </div>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Preço</th>
                                    <th>Dias</th>
                                    <th>Contas</th>
                                    <th>Jogos</th>
                                    <th>Ativo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="plansTableBody">
                                <tr><td colspan="8" style="text-align: center;">Carregando planos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>Licenças Geradas</h2>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Chave</th>
                                    <th>Plano</th>
                                    <th>Duração</th>
                                    <th>Status</th>
                                    <th>Usada por</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="licensesTableBody">
                                <tr><td colspan="6" style="text-align: center;">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>Usuários Registrados</h2>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Usuário</th>
                                    <th>Email</th>
                                    <th>Plano</th>
                                    <th>Expira Em</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="6" style="text-align: center;">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div> 

    <div id="editPlanModal" class="modal">
        <div class="modal-content">
            <h2 id="modalPlanTitle">Editar Plano</h2>
            <div class="settings-form-row"><label>ID (Slug):</label><input type="text" id="editPlanId" placeholder="ex: premium-pro"></div>
            <div class="settings-form-row"><label>Nome Visível:</label><input type="text" id="editPlanName"></div>
            <div class="settings-form-row"><label>Preço (R$):</label><input type="number" id="editPlanPrice" step="0.01"></div>
            <div class="settings-form-row"><label>Duração (Dias, 0=inf):</label><input type="number" id="editPlanDays"></div>
            <div class="settings-form-row"><label>Limite Contas:</label><input type="number" id="editPlanAccounts"></div>
            <div class="settings-form-row"><label>Limite Jogos:</label><input type="number" id="editPlanGames"></div>
            <div class="settings-form-row"><label>Estilo:</label>
                <select id="editPlanStyle">
                    <option value="none">Nenhum</option>
                    <option value="fire">Fogo (Premium)</option>
                    <option value="cosmic">Cósmico (Lifetime)</option>
                </select>
            </div>
            <div class="settings-form-row"><label>Ativo:</label><select id="editPlanActive"><option value="true">Sim</option><option value="false">Não</option></select></div>
            <p>Funcionalidades (uma por linha):</p>
            <textarea id="editPlanFeatures" rows="6"></textarea>
            <button id="savePlanButton">Salvar Alterações</button>
            <button id="closeEditPlanModal" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        function showToast(message, type = 'info') { 
            const c = document.getElementById('toastContainer'); 
            const t = document.createElement('div'); 
            t.className = `toast ${type}`; 
            t.textContent = message; 
            c.appendChild(t); 
            setTimeout(() => t.classList.add('show'), 10); 
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, 4000); 
        }

        const userMap = new Map(); 
        let allPlans = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Referencias
            const usersTableBody = document.getElementById('usersTableBody');
            const licensesTableBody = document.getElementById('licensesTableBody'); 
            const plansTableBody = document.getElementById('plansTableBody');
            const generateKeysButton = document.getElementById('generateKeysButton');
            const planSelect = document.getElementById('planSelect');
            const quantityInput = document.getElementById('quantityInput');
            const durationInput = document.getElementById('durationInput'); 
            const generatedKeys = document.getElementById('generatedKeys');
            const keysOutput = document.getElementById('keysOutput');
            
            // Modal Edição
            const editPlanModal = document.getElementById('editPlanModal');
            const addPlanButton = document.getElementById('addPlanButton');
            
            // --- Fetch Plans (ADMIN ROUTE) ---
            async function fetchPlans() {
                try {
                    const res = await fetch('/api/admin/all-plans'); // Rota que traz TUDO
                    allPlans = await res.json();
                    renderPlans(allPlans);
                    
                    // Update Generator Select
                    planSelect.innerHTML = '';
                    allPlans.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.name;
                        planSelect.appendChild(opt);
                    });
                } catch(e) { showToast("Erro ao carregar planos.", 'error'); }
            }

            function renderPlans(plans) {
                plansTableBody.innerHTML = '';
                plans.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>R$ ${p.price}</td>
                        <td>${p.days}</td>
                        <td>${p.accounts}</td>
                        <td>${p.games}</td>
                        <td>${p.active ? '<span style="color:#90ee90">Sim</span>' : '<span style="color:#ff6B6B">Não</span>'}</td>
                        <td class="actions-cell">
                            <button class="assign-key-btn" onclick='openEditPlan("${p.id}")'>Editar</button>
                            <button class="delete-key-btn" onclick='deletePlan("${p.id}")'>Excluir</button>
                        </td>
                    `;
                    plansTableBody.appendChild(row);
                });
            }

            // --- CREATE NEW PLAN ---
            addPlanButton.onclick = () => {
                document.getElementById('modalPlanTitle').textContent = 'Criar Novo Plano';
                document.getElementById('editPlanId').value = '';
                document.getElementById('editPlanId').disabled = false; // ID editável na criação
                document.getElementById('editPlanName').value = '';
                document.getElementById('editPlanPrice').value = '';
                document.getElementById('editPlanDays').value = 30;
                document.getElementById('editPlanAccounts').value = 1;
                document.getElementById('editPlanGames').value = 1;
                document.getElementById('editPlanStyle').value = 'none';
                document.getElementById('editPlanActive').value = 'true';
                document.getElementById('editPlanFeatures').value = '';
                editPlanModal.style.display = 'block';
            };

            // --- EDIT PLAN ---
            window.openEditPlan = (planId) => {
                const p = allPlans.find(x => x.id === planId);
                if (!p) return;
                document.getElementById('modalPlanTitle').textContent = 'Editar Plano';
                document.getElementById('editPlanId').value = p.id;
                document.getElementById('editPlanId').disabled = true; // ID fixo na edição
                document.getElementById('editPlanName').value = p.name;
                document.getElementById('editPlanPrice').value = p.price;
                document.getElementById('editPlanDays').value = p.days;
                document.getElementById('editPlanAccounts').value = p.accounts;
                document.getElementById('editPlanGames').value = p.games;
                document.getElementById('editPlanStyle').value = p.style;
                document.getElementById('editPlanActive').value = p.active.toString();
                document.getElementById('editPlanFeatures').value = p.features.join('\n');
                editPlanModal.style.display = 'block';
            }

            // --- DELETE PLAN ---
            window.deletePlan = async (planId) => {
                if (!confirm(`Tem certeza que deseja EXCLUIR o plano "${planId}"? Isso pode quebrar contas que usam este plano.`)) return;
                try {
                    const res = await fetch('/api/admin/delete-plan', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: planId })
                    });
                    if (res.ok) {
                        showToast('Plano excluído.');
                        fetchPlans();
                    } else {
                        showToast('Erro ao excluir.', 'error');
                    }
                } catch(e) { showToast('Erro de rede.', 'error'); }
            };

            document.getElementById('closeEditPlanModal').onclick = () => editPlanModal.style.display = 'none';
            
            document.getElementById('savePlanButton').onclick = async () => {
                const updatedPlan = {
                    id: document.getElementById('editPlanId').value,
                    name: document.getElementById('editPlanName').value,
                    price: document.getElementById('editPlanPrice').value,
                    days: document.getElementById('editPlanDays').value,
                    accounts: document.getElementById('editPlanAccounts').value,
                    games: document.getElementById('editPlanGames').value,
                    style: document.getElementById('editPlanStyle').value,
                    active: document.getElementById('editPlanActive').value === 'true',
                    features: document.getElementById('editPlanFeatures').value.split('\n').filter(x => x.trim() !== '')
                };

                if (!updatedPlan.id) return showToast("ID é obrigatório.", 'error');

                const res = await fetch('/api/admin/update-plan-details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedPlan)
                });

                if (res.ok) {
                    showToast('Plano salvo com sucesso!');
                    editPlanModal.style.display = 'none';
                    fetchPlans();
                } else {
                    showToast('Erro ao salvar.', 'error');
                }
            };

            // --- Existing Fetch Functions (Users, Licenses) ---
            async function fetchUsers() {
                try {
                    const response = await fetch('/api/admin/users');
                    if (!response.ok && response.status === 401) window.location.href = '/admin/login?error=unauthorized';
                    const users = await response.json();
                    renderUsers(users);
                    userMap.clear();
                    users.forEach(user => userMap.set(user._id, user.username));
                } catch (e) {}
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                try { return new Date(dateString).toLocaleDateString('pt-BR'); } catch (e) { return 'Inválida'; }
            }

            function renderUsers(users) {
                usersTableBody.innerHTML = '';
                if (users.length === 0) { usersTableBody.innerHTML = '<tr><td colspan="6">Sem usuários.</td></tr>'; return; }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const isBanned = user.isBanned || false;
                    
                    // Dropdown de Planos Dinâmico
                    let planOptions = '';
                    allPlans.forEach(p => {
                        planOptions += `<option value="${p.id}" ${user.plan === p.id ? 'selected' : ''}>${p.name}</option>`;
                    });

                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td><select class="plan-select" data-userid="${user._id}">${planOptions}</select></td>
                        <td>${user.planExpiresAt ? formatDate(user.planExpiresAt) : (user.plan === 'free' ? 'N/A' : 'Vitalício')}</td>
                        <td class="${isBanned ? 'status-banned' : ''}">${isBanned ? 'Banido' : 'Ativo'}</td>
                        <td class="actions-cell">
                            <button class="${isBanned ? 'unban-btn' : 'ban-btn'}" data-userid="${user._id}">${isBanned ? 'Desbanir' : 'Banir'}</button>
                            <button class="delete-btn" data-userid="${user._id}">Excluir</button>
                        </td>
                    `;
                    usersTableBody.appendChild(row);
                });
            }

            async function fetchLicenses() {
                try {
                    const response = await fetch('/api/admin/licenses');
                    const licenses = await response.json();
                    renderLicenses(licenses);
                } catch (e) {}
            }
            
            function renderLicenses(licenses) {
                licensesTableBody.innerHTML = '';
                if (licenses.length === 0) { licensesTableBody.innerHTML = '<tr><td colspan="6">Sem licenças.</td></tr>'; return; }
                licenses.forEach(key => {
                    const row = document.createElement('tr');
                    const isUsed = key.isUsed || false;
                    let statusText = isUsed ? 'Usada' : (key.assignedToUsername ? 'Atribuída' : 'Não Usada');
                    let statusClass = isUsed ? 'status-used' : (key.assignedToUsername ? 'status-pending-admin' : 'status-unused');
                    let actions = isUsed ? '' : (key.assignedToUsername ? '' : `<button class="assign-key-btn" data-licenseid="${key._id}">Atribuir</button> <button class="delete-key-btn" data-licenseid="${key._id}">Deletar</button>`);
                    
                    row.innerHTML = `
                        <td>${key.key}</td>
                        <td>${key.plan}</td>
                        <td>${key.durationDays ? `${key.durationDays} dias` : 'Vitalícia'}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${isUsed ? (userMap.get(key.usedBy) || 'Ex-Usuário') : (key.assignedToUsername || 'N/A')}</td>
                        <td class="actions-cell">${actions}</td>
                    `;
                    licensesTableBody.appendChild(row);
                });
            }

            // Listeners (Gerar, Banir, Atribuir) - Mantidos iguais
            generateKeysButton.addEventListener('click', async () => {
                try {
                    const res = await fetch('/api/admin/generate-keys', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan: planSelect.value, quantity: quantityInput.value, durationDays: durationInput.value})});
                    const data = await res.json();
                    if(data.keys){ keysOutput.textContent=data.keys.join('\n'); generatedKeys.style.display='block'; fetchLicenses(); }
                } catch(e){}
            });
            
            // ... (Resto dos listeners de Banir, Excluir, Atribuir que já existiam) ...
             usersTableBody.addEventListener('click', async (e) => { 
                const target = e.target;
                const userId = target.dataset.userid;
                if (!userId) return;
                let url, actionText, body;
                if (target.classList.contains('ban-btn') || target.classList.contains('unban-btn')) {
                    const isBanning = target.classList.contains('ban-btn');
                    url = isBanning ? '/api/admin/ban-user' : '/api/admin/unban-user';
                    actionText = isBanning ? 'banir' : 'desbanir';
                    body = JSON.stringify({ userId });
                } else if (target.classList.contains('delete-btn')) {
                    url = '/api/admin/delete-user';
                    actionText = 'EXCLUIR PERMANENTEMENTE';
                    body = JSON.stringify({ userId });
                } else return;
                if (!confirm(`Tem certeza que deseja ${actionText} este usuário?`)) return;
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body });
                    if (response.ok) fetchUsers();
                } catch (e) { showToast(`Erro ao ${actionText} usuário.`, 'error'); }
             });

             usersTableBody.addEventListener('change', async (e) => { 
                 if (e.target.classList.contains('plan-select')) {
                    const userId = e.target.dataset.userid;
                    const newPlan = e.target.value;
                    if (!confirm(`Mudar plano para ${newPlan}? (Vitalício)`)) { fetchUsers(); return; }
                    await fetch('/api/admin/update-plan', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ userId, newPlan })});
                    fetchUsers();
                }
             });

             licensesTableBody.addEventListener('click', async (e) => { 
                const target = e.target;
                const licenseId = target.dataset.licenseid;
                if (!licenseId) return;
                if (target.classList.contains('delete-key-btn')) {
                    if (!confirm('Deletar chave?')) return;
                    await fetch('/api/admin/delete-license', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ licenseId })});
                    fetchLicenses();
                } else if (target.classList.contains('assign-key-btn')) {
                    const username = prompt("Nome de usuário para atribuir:");
                    if (!username) return;
                    const res = await fetch('/api/admin/assign-key', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ licenseId, username })});
                    const d = await res.json();
                    showToast(d.message, res.ok?'info':'error');
                    fetchLicenses();
                }
             });

             // Inicialização
             fetchPlans().then(() => {
                 fetchUsers();
                 fetchLicenses();
             });
        });
    </script>
</body>
</html>
