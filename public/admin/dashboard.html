<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - STF Boost</title>
    <link rel="icon" type="image/png" href="/logo.png?v=1.1">
    <link rel="stylesheet" href="/style.css?v=2.2"> 
</head>
<body class="panel-page">
    <div class="dashboard-layout">
        <nav class="sidebar">
            <div class="sidebar-logo">
                <img src="/logo.png" alt="Logo">
                <h1 class="glitch-title" data-text="ADMIN">ADMIN</h1>
            </div>
            <div class="sidebar-user">
                <span id="sidebarUser">Painel de Admin</span>
                <span id="sidebarPlan" style="margin-top: 4px;">Controlo Total</span>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Gestão</span>
                <a href="/admin/dashboard" class="active"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> Usuários e Licenças</a>
            </div>
            <div class="sidebar-nav">
                <span class="nav-title">Site</span>
                <a href="/"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Ver Landing Page</a>
                <a href="/admin/logout" class="logout-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Logout</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="admin-container">
                
                <div class="admin-card">
                    <h2>Gerador de Licenças</h2>
                    <div class="admin-form">
                        <label for="planSelect">Plano:</label>
                        <select id="planSelect"></select>
                        <label for="quantityInput">Qtd:</label>
                        <input type="number" id="quantityInput" value="1" min="1" max="50">
                        <label for="durationInput">Dias:</label>
                        <input type="number" id="durationInput" placeholder="Padrão">
                        <button id="generateKeysButton">Gerar</button>
                    </div>
                    <div id="generatedKeys"><pre id="keysOutput"></pre></div>
                </div>

                <div class="admin-card">
                    <h2>Gestão de Cupons</h2>
                    <div class="admin-form">
                        <label>Código:</label>
                        <input type="text" id="couponCodeInput" placeholder="EX: NATAL10">
                        <label>Desconto (%):</label>
                        <input type="number" id="couponDiscountInput" placeholder="10" max="100">
                        <button id="createCouponButton" class="assign-key-btn">Criar Cupom</button>
                    </div>
                    <div class="admin-table-wrapper" style="margin-top: 15px;">
                        <table class="admin-table">
                            <thead><tr><th>Código</th><th>Desconto</th><th>Usos</th><th>Ações</th></tr></thead>
                            <tbody id="couponsTableBody"><tr><td colspan="4" style="text-align: center;">Carregando...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Gestão de Planos</h2>
                        <button id="addPlanButton" class="assign-key-btn">Criar Novo</button>
                    </div>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead><tr><th>ID</th><th>Nome</th><th>Preço</th><th>Dias</th><th>Ações</th></tr></thead>
                            <tbody id="plansTableBody"><tr><td colspan="5" style="text-align: center;">Carregando...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>Licenças Geradas</h2>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead><tr><th>Chave</th><th>Plano</th><th>Status</th><th>Usada por</th><th>Ações</th></tr></thead>
                            <tbody id="licensesTableBody"><tr><td colspan="5" style="text-align: center;">Carregando...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>Usuários</h2>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead><tr><th>Usuário</th><th>Plano</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="usersTableBody"><tr><td colspan="4" style="text-align: center;">Carregando...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div> 

    <div id="editPlanModal" class="modal">
        <div class="modal-content">
            <h2 id="modalPlanTitle">Editar Plano</h2>
            <input type="hidden" id="editPlanId">
            <div class="settings-form-row"><label>ID:</label><input type="text" id="editPlanIdDisplay"></div>
            <div class="settings-form-row"><label>Nome:</label><input type="text" id="editPlanName"></div>
            <div class="settings-form-row"><label>Preço:</label><input type="number" id="editPlanPrice" step="0.01"></div>
            <div class="settings-form-row"><label>Dias:</label><input type="number" id="editPlanDays"></div>
            <div class="settings-form-row"><label>Contas:</label><input type="number" id="editPlanAccounts"></div>
            <div class="settings-form-row"><label>Jogos:</label><input type="number" id="editPlanGames"></div>
            <div class="settings-form-row"><label>Estilo:</label><select id="editPlanStyle"><option value="none">Normal</option><option value="fire">Fogo</option><option value="cosmic">Cósmico</option><option value="halloween">Halloween</option><option value="christmas">Natal</option><option value="newyear">Ano Novo</option></select></div>
            <div class="settings-form-row"><label>Ativo:</label><select id="editPlanActive"><option value="true">Sim</option><option value="false">Não</option></select></div>
            <p>Features:</p><textarea id="editPlanFeatures" rows="4"></textarea>
            <button id="savePlanButton">Salvar</button>
            <button id="closeEditPlanModal" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        function showToast(msg, type='info') { const c=document.getElementById('toastContainer'), t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),500)},4000); }
        const userMap = new Map(); let allPlans = [];

        document.addEventListener('DOMContentLoaded', () => {
            const usersTableBody = document.getElementById('usersTableBody');
            const licensesTableBody = document.getElementById('licensesTableBody'); 
            const plansTableBody = document.getElementById('plansTableBody');
            const couponsTableBody = document.getElementById('couponsTableBody');
            const planSelect = document.getElementById('planSelect');
            
            async function fetchAll() {
                await fetchPlans(); await fetchUsers(); await fetchLicenses(); await fetchCoupons();
            }

            async function fetchPlans() {
                try {
                    const res = await fetch('/api/admin/all-plans'); allPlans = await res.json();
                    plansTableBody.innerHTML = ''; planSelect.innerHTML = '';
                    allPlans.forEach(p => {
                        const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; planSelect.appendChild(opt);
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>R$ ${p.price}</td><td>${p.days}</td><td class="actions-cell"><button class="assign-key-btn" onclick='openEditPlan("${p.id}")'>Edit</button><button class="delete-key-btn" onclick='deletePlan("${p.id}")'>Del</button></td>`;
                        plansTableBody.appendChild(row);
                    });
                } catch(e) {}
            }

            // Cupons
            async function fetchCoupons() {
                try {
                    const res = await fetch('/api/admin/coupons'); const coupons = await res.json();
                    couponsTableBody.innerHTML = '';
                    if(coupons.length===0) couponsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Sem cupons.</td></tr>';
                    coupons.forEach(c => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td><code style="color:var(--primary-color)">${c.code}</code></td><td>${c.discount}%</td><td>${c.usageCount || 0}</td><td class="actions-cell"><button class="delete-key-btn" onclick='deleteCoupon("${c._id}")'>Excluir</button></td>`;
                        couponsTableBody.appendChild(row);
                    });
                } catch(e) {}
            }

            document.getElementById('createCouponButton').onclick = async () => {
                const code = document.getElementById('couponCodeInput').value.trim();
                const discount = document.getElementById('couponDiscountInput').value;
                if(!code || !discount) return showToast("Preencha tudo.", 'error');
                const res = await fetch('/api/admin/create-coupon', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code, discount})});
                if(res.ok) { showToast("Cupom criado!"); fetchCoupons(); document.getElementById('couponCodeInput').value=''; }
            };

            window.deleteCoupon = async (id) => {
                if(!confirm("Excluir cupom?")) return;
                await fetch('/api/admin/delete-coupon', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
                fetchCoupons();
            };

            async function fetchUsers() { const res = await fetch('/api/admin/users'); const users = await res.json(); users.forEach(u => userMap.set(u._id, u.username)); renderUsers(users); }
            
            function renderUsers(users) { 
                usersTableBody.innerHTML = '';
                users.forEach(u => {
                    const row = document.createElement('tr');
                    let opts = ''; allPlans.forEach(p => opts += `<option value="${p.id}" ${u.plan===p.id?'selected':''}>${p.name}</option>`);
                    // Adicionado Botão de Excluir e melhoria visual do Status
                    row.innerHTML = `
                        <td>${u.username}</td>
                        <td><select class="plan-select" data-uid="${u._id}">${opts}</select></td>
                        <td class="${u.isBanned ? 'status-banned' : 'status-unused'}">${u.isBanned ? 'BANIDO' : 'Ativo'}</td>
                        <td class="actions-cell">
                            <button class="ban-btn" data-uid="${u._id}">${u.isBanned ? 'Desbanir' : 'Banir'}</button>
                            <button class="delete-btn" data-uid="${u._id}" style="border-color: #ff6B6B; color: #ff6B6B; margin-left: 5px; font-size: 12px; padding: 5px 10px;">Excluir</button>
                        </td>`;
                    usersTableBody.appendChild(row);
                });
            }
            
            async function fetchLicenses() { const res = await fetch('/api/admin/licenses'); const lic = await res.json(); renderLicenses(lic); }
            function renderLicenses(lic) {
                licensesTableBody.innerHTML = '';
                lic.forEach(k => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${k.key}</td><td>${k.plan}</td><td>${k.isUsed?'Usado':'Livre'}</td><td>${k.assignedToUsername||'-'}</td><td class="actions-cell">${!k.isUsed?`<button class="assign-key-btn" data-lid="${k._id}">Atribuir</button><button class="delete-key-btn" data-lid="${k._id}">Del</button>`:''}</td>`;
                    licensesTableBody.appendChild(row);
                });
            }

            document.getElementById('generateKeysButton').onclick = async () => {
                await fetch('/api/admin/generate-keys', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan:document.getElementById('planSelect').value, quantity:document.getElementById('quantityInput').value})});
                fetchLicenses();
            };
            
            usersTableBody.onclick = async (e) => {
                // Ação de Banir/Desbanir
                if(e.target.classList.contains('ban-btn')) {
                    const uid = e.target.dataset.uid;
                    const isUnban = e.target.textContent === 'Desbanir';
                    const endpoint = isUnban ? '/api/admin/unban-user' : '/api/admin/ban-user';
                    
                    try {
                        const res = await fetch(endpoint, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:uid})});
                        const data = await res.json();
                        if(res.ok) {
                            showToast(data.message, 'info');
                            fetchUsers();
                        } else {
                            showToast('Erro ao alterar status.', 'error');
                        }
                    } catch(err) { showToast('Erro de conexão.', 'error'); }
                }
                
                // Ação de Excluir Usuário
                if(e.target.classList.contains('delete-btn')) {
                    const uid = e.target.dataset.uid;
                    if(confirm('TEM CERTEZA? Isso apagará o usuário, todas as contas Steam associadas e encerrará os processos ativos. Esta ação é irreversível.')) {
                        try {
                            const res = await fetch('/api/admin/delete-user', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:uid})});
                            const data = await res.json();
                            if(res.ok) {
                                showToast(data.message, 'info');
                                fetchUsers();
                            } else {
                                showToast('Erro ao excluir usuário.', 'error');
                            }
                        } catch(err) { showToast('Erro de conexão.', 'error'); }
                    }
                }
            };

            usersTableBody.onchange = async (e) => {
                if(e.target.classList.contains('plan-select')) {
                    const res = await fetch('/api/admin/update-plan', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:e.target.dataset.uid, newPlan:e.target.value})});
                    const data = await res.json();
                    showToast(data.message, 'info');
                }
            };

            licensesTableBody.onclick = async (e) => {
                if(e.target.classList.contains('delete-key-btn')) {
                    await fetch('/api/admin/delete-license', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({licenseId:e.target.dataset.lid})});
                    fetchLicenses();
                }
                if(e.target.classList.contains('assign-key-btn')) {
                    const u = prompt("User:"); if(u) {
                        await fetch('/api/admin/assign-key', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({licenseId:e.target.dataset.lid, username:u})});
                        fetchLicenses();
                    }
                }
            };

            const editModal = document.getElementById('editPlanModal');
            window.openEditPlan = (id) => {
                const p = allPlans.find(x=>x.id===id);
                document.getElementById('editPlanId').value = p.id; document.getElementById('editPlanIdDisplay').value = p.id;
                document.getElementById('editPlanName').value = p.name; document.getElementById('editPlanPrice').value = p.price;
                document.getElementById('editPlanDays').value = p.days; document.getElementById('editPlanAccounts').value = p.accounts;
                document.getElementById('editPlanGames').value = p.games; document.getElementById('editPlanFeatures').value = p.features.join('\n');
                editModal.style.display = 'block';
            };
            document.getElementById('savePlanButton').onclick = async () => {
                const data = {
                    id: document.getElementById('editPlanId').value,
                    name: document.getElementById('editPlanName').value,
                    price: document.getElementById('editPlanPrice').value,
                    days: document.getElementById('editPlanDays').value,
                    accounts: document.getElementById('editPlanAccounts').value,
                    games: document.getElementById('editPlanGames').value,
                    style: document.getElementById('editPlanStyle').value,
                    active: document.getElementById('editPlanActive').value === 'true',
                    features: document.getElementById('editPlanFeatures').value.split('\n')
                };
                await fetch('/api/admin/update-plan-details', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
                editModal.style.display = 'none'; fetchPlans();
            };
            document.getElementById('closeEditPlanModal').onclick = () => editModal.style.display = 'none';
            document.getElementById('addPlanButton').onclick = () => { 
                document.getElementById('editPlanId').value = ''; document.getElementById('editPlanIdDisplay').value = ''; 
                editModal.style.display = 'block'; 
            };
            window.deletePlan = async(id) => {
                 if(confirm('Del?')) { await fetch('/api/admin/delete-plan', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); fetchPlans(); }
            };

            fetchAll();
        });
    </script>
</body>
</html>
