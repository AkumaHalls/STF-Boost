<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - STF Steam Boost</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="control-panel">
        <header>
            <h1>STF Steam Boost</h1>
            <button id="addAccountButton">Adicionar Conta</button>
        </header>
        <div class="accounts-table">
            <table>
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Status</th>
                        <th>Tempo Ativo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="accountsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addAccountButton = document.getElementById('addAccountButton');
            const accountsTableBody = document.getElementById('accountsTableBody');

            function formatUptime(ms) {
                if (ms <= 0) return '00:00:00';
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            }

            async function updateUI() {
                try {
                    const response = await fetch('/status');
                    const data = await response.json();
                    const accounts = data.accounts;
                    
                    accountsTableBody.innerHTML = '';

                    if (Object.keys(accounts).length === 0) {
                        accountsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Nenhuma conta adicionada. Clique em "Adicionar Conta".</td></tr>`;
                    }

                    for (const username in accounts) {
                        const acc = accounts[username];
                        const row = document.createElement('tr');

                        // Célula do Usuário
                        const userCell = document.createElement('td');
                        userCell.textContent = acc.username;

                        // Célula do Status
                        const statusCell = document.createElement('td');
                        statusCell.textContent = acc.status;
                        statusCell.className = '';
                        if (acc.status === "Rodando") statusCell.classList.add('status-running');
                        else if (acc.status === "Parado") statusCell.classList.add('status-stopped');
                        else statusCell.classList.add('status-pending');

                        // Célula do Tempo Ativo
                        const uptimeCell = document.createElement('td');
                        uptimeCell.textContent = formatUptime(acc.uptime);

                        // Célula das Ações
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'actions-cell';
                        
                        const startStopBtn = document.createElement('button');
                        startStopBtn.textContent = (acc.status === "Rodando") ? "Parar" : "Iniciar";
                        startStopBtn.className = (acc.status === "Rodando") ? 'stop-btn' : 'start-btn';
                        startStopBtn.onclick = () => {
                            const action = (acc.status === "Rodando") ? 'stop' : 'start';
                            fetch(`/${action}/${acc.username}`, { method: 'POST' }).finally(() => setTimeout(updateUI, 500));
                        };
                        
                        const guardBtn = document.createElement('button');
                        guardBtn.textContent = "Guard";
                        if (acc.status === "Pendente: Steam Guard") guardBtn.classList.add('pulse-attention');
                        guardBtn.onclick = () => {
                            const code = prompt(`Insira o código do Steam Guard para ${acc.username}:`);
                            if (code) {
                                fetch(`/submit-guard/${acc.username}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ code })
                                }).finally(() => setTimeout(updateUI, 1000));
                            }
                        };
                        
                        // Adicionar mais botões como 'Gerir Jogos' ou 'Remover' aqui no futuro
                        
                        actionsCell.append(startStopBtn, guardBtn);
                        row.append(userCell, statusCell, uptimeCell, actionsCell);
                        accountsTableBody.appendChild(row);

                    }
                } catch(e) {
                    accountsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Erro ao carregar dados. Verifique a conexão com o servidor.</td></tr>`;
                }
            }

            addAccountButton.addEventListener('click', async () => {
                const username = prompt("Nome de usuário da nova conta Steam:");
                if (!username) return;
                const password = prompt(`Senha para a conta ${username}:`);
                if (!password) return;

                const response = await fetch('/add-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                alert(result.message);
                updateUI();
            });

            updateUI();
            setInterval(updateUI, 2000);
        });
    </script>
</body>
</html>
