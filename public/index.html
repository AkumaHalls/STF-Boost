<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - STF Steam Boost</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="control-panel">
        <header>
            <h1>STF Steam Boost</h1>
            <button id="addAccountButton">Adicionar Conta</button>
        </header>
        <div class="accounts-table">
            <table>
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Status</th>
                        <th>Tempo Ativo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="accountsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="gamesModal" class="modal">
        <div class="modal-content">
            <h2>Gerir Jogos</h2>
            <p>Selecione os jogos que deseja impulsionar.</p>
            <div id="selectedGames"></div>
            <input type="text" id="searchInput" placeholder="Pesquisar jogos por nome...">
            <ul id="resultsList"></ul>
            <button id="saveGamesButton">Salvar</button>
            <button id="closeModalButton" class="remove-btn">Cancelar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seletores de Elementos ---
            const addAccountButton = document.getElementById('addAccountButton');
            const accountsTableBody = document.getElementById('accountsTableBody');
            
            // Elementos da Modal
            const gamesModal = document.getElementById('gamesModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const searchInput = document.getElementById('searchInput');
            const resultsList = document.getElementById('resultsList');
            const selectedGamesContainer = document.getElementById('selectedGames');
            const saveGamesButton = document.getElementById('saveGamesButton');

            // --- Variáveis de Estado da UI ---
            let currentlyEditingGamesFor = null;
            let selectedGames = [];

            // --- Funções Auxiliares ---
            function formatUptime(ms) {
                if (ms <= 0) return '00:00:00';
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            }

            // --- Função Principal de Renderização ---
            async function updateUI() {
                try {
                    const response = await fetch('/status');
                    const data = await response.json();
                    const accounts = data.accounts;
                    
                    accountsTableBody.innerHTML = '';

                    if (Object.keys(accounts).length === 0) {
                        accountsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Nenhuma conta adicionada. Clique em "Adicionar Conta".</td></tr>`;
                    }

                    for (const username in accounts) {
                        const acc = accounts[username];
                        const row = document.createElement('tr');

                        // Células da Tabela
                        row.innerHTML = `
                            <td>${acc.username}</td>
                            <td class="status-cell">${acc.status}</td>
                            <td>${formatUptime(acc.uptime)}</td>
                            <td class="actions-cell"></td>
                        `;

                        const statusCell = row.querySelector('.status-cell');
                        statusCell.className = 'status-cell';
                        if (acc.status === "Rodando") statusCell.classList.add('status-running');
                        else if (acc.status === "Parado") statusCell.classList.add('status-stopped');
                        else statusCell.classList.add('status-pending');

                        // Botões de Ação
                        const actionsCell = row.querySelector('.actions-cell');
                        
                        const startStopBtn = document.createElement('button');
                        startStopBtn.textContent = (acc.status === "Rodando") ? "Parar" : "Iniciar";
                        startStopBtn.className = (acc.status === "Rodando") ? 'stop-btn' : 'start-btn';
                        startStopBtn.onclick = () => {
                            const action = (acc.status === "Rodando") ? 'stop' : 'start';
                            fetch(`/${action}/${acc.username}`, { method: 'POST' }).finally(() => setTimeout(updateUI, 500));
                        };
                        
                        const guardBtn = document.createElement('button');
                        guardBtn.textContent = "Guard";
                        if (acc.status === "Pendente: Steam Guard") guardBtn.classList.add('pulse-attention');
                        guardBtn.onclick = () => {
                            const code = prompt(`Insira o código do Steam Guard para ${acc.username}:`);
                            if (code) fetch(`/submit-guard/${acc.username}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code }) }).finally(() => setTimeout(updateUI, 1000));
                        };

                        const manageBtn = document.createElement('button');
                        manageBtn.textContent = "Jogos";
                        manageBtn.disabled = !data.appListReady;
                        manageBtn.title = data.appListReady ? "Gerir jogos" : "Aguarde o carregamento da lista de jogos.";
                        manageBtn.onclick = () => {
                            currentlyEditingGamesFor = acc.username;
                            selectedGames = acc.games.map(appid => ({ appid, name: `Carregando... (${appid})` })); // Placeholder
                            renderSelectedGames();
                            gamesModal.style.display = 'block';
                        };
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = "Remover";
                        removeBtn.className = "remove-btn";
                        removeBtn.onclick = () => {
                            if (confirm(`Tem a certeza que deseja remover a conta ${acc.username}? Esta ação é irreversível.`)) {
                                fetch(`/remove-account/${acc.username}`, { method: 'DELETE' }).finally(() => setTimeout(updateUI, 500));
                            }
                        };

                        actionsCell.append(startStopBtn, guardBtn, manageBtn, removeBtn);
                        accountsTableBody.appendChild(row);
                    }
                } catch(e) {
                    accountsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Erro ao carregar dados. Verifique a conexão com o servidor.</td></tr>`;
                }
            }

            // --- Lógica dos Botões e Modal ---

            addAccountButton.addEventListener('click', async () => {
                const username = prompt("Nome de usuário da nova conta Steam:");
                if (!username) return;
                const password = prompt(`Senha para a conta ${username}:`);
                if (!password) return;
                const response = await fetch('/add-account', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                const result = await response.json();
                alert(result.message);
                updateUI();
            });

            const hideModal = () => {
                gamesModal.style.display = 'none';
                resultsList.innerHTML = '';
                searchInput.value = '';
            }
            closeModalButton.addEventListener('click', hideModal);
            window.addEventListener('click', (event) => { if (event.target == gamesModal) hideModal(); });

            searchInput.addEventListener('input', async () => {
                const query = searchInput.value;
                resultsList.innerHTML = '';
                if (query.length < 2) return;
                
                const response = await fetch(`/search-games?q=${query}`);
                const games = await response.json();
                games.forEach(game => {
                    const li = document.createElement('li');
                    li.textContent = `${game.name} (${game.appid})`;
                    li.onclick = () => selectGame(game);
                    resultsList.appendChild(li);
                });
            });

            function selectGame(game) {
                if (!selectedGames.find(g => g.appid === game.appid)) {
                    selectedGames.push(game);
                    renderSelectedGames();
                }
                searchInput.value = '';
                resultsList.innerHTML = '';
            }

            function renderSelectedGames() {
                selectedGamesContainer.innerHTML = '';
                selectedGames.forEach(game => {
                    const pill = document.createElement('div');
                    pill.className = 'game-pill';
                    pill.textContent = game.name;
                    const removeSpan = document.createElement('span');
                    removeSpan.textContent = 'x';
                    removeSpan.onclick = () => removeGame(game.appid);
                    pill.appendChild(removeSpan);
                    selectedGamesContainer.appendChild(pill);
                });
            }

            function removeGame(appid) {
                selectedGames = selectedGames.filter(g => g.appid !== appid);
                renderSelectedGames();
            }

            saveGamesButton.addEventListener('click', () => {
                if (!currentlyEditingGamesFor) return;
                const gamesArray = selectedGames.map(g => g.appid);
                fetch(`/set-games/${currentlyEditingGamesFor}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ games: gamesArray }) })
                    .then(() => hideModal());
            });

            // --- Inicialização ---
            updateUI();
            setInterval(updateUI, 3000);
        });
    </script>
</body>
</html>
