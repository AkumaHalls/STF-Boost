<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - STF Steam Boost</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="control-panel">
        </div>

    <div id="gamesModal" class="modal">
        <div class="modal-content">
            <h2>Gerir Jogos</h2>
            <p>Selecione os jogos que deseja impulsionar.</p>
            <div id="selectedGames"></div>
            <input type="text" id="searchInput" placeholder="Pesquisar jogos por nome ou AppID...">
            <ul id="resultsList"></ul>
            <button id="saveGamesButton">Salvar</button>
        </div>
    </div>
    <script>
        // --- Todo o JavaScript anterior para botões Iniciar, Steam Guard, e updateStatus ---
        // ...

        // --- NOVA LÓGICA PARA A JANELA MODAL DE JOGOS ---

        const gamesModal = document.getElementById('gamesModal');
        const manageGamesButton = document.getElementById('manageGamesButton');
        const searchInput = document.getElementById('searchInput');
        const resultsList = document.getElementById('resultsList');
        const selectedGamesContainer = document.getElementById('selectedGames');
        const saveGamesButton = document.getElementById('saveGamesButton');

        let selectedGames = []; // Array para guardar os jogos selecionados {appid, name}

        // Abrir a modal
        manageGamesButton.addEventListener('click', async () => {
            // Pega a lista de jogos atual do servidor para popular a modal
            const response = await fetch('/status');
            const state = await response.json();
            // Precisamos de um truque aqui, pois só temos os IDs. Vamos assumir que começamos com os nomes vazios.
            selectedGames = state.games.map(appid => ({ appid, name: `Jogo ${appid}` }));
            renderSelectedGames();
            gamesModal.style.display = 'block';
        });
        
        // Fechar a modal (clicando fora)
        window.addEventListener('click', (event) => {
            if (event.target == gamesModal) {
                gamesModal.style.display = 'none';
            }
        });

        // Lógica da pesquisa
        searchInput.addEventListener('keyup', async () => {
            const query = searchInput.value;
            resultsList.innerHTML = ''; // Limpa resultados antigos

            if (query.length < 3) return;

            const response = await fetch(`/search-games?q=${query}`);
            const games = await response.json();
            
            games.forEach(game => {
                const li = document.createElement('li');
                li.textContent = `${game.name} (${game.appid})`;
                li.onclick = () => selectGame(game);
                resultsList.appendChild(li);
            });
        });

        function selectGame(game) {
            if (!selectedGames.find(g => g.appid === game.appid)) {
                selectedGames.push(game);
                renderSelectedGames();
            }
            searchInput.value = '';
            resultsList.innerHTML = '';
        }

        function renderSelectedGames() {
            selectedGamesContainer.innerHTML = '';
            selectedGames.forEach(game => {
                const pill = document.createElement('div');
                pill.className = 'game-pill';
                pill.textContent = game.name;
                const removeSpan = document.createElement('span');
                removeSpan.textContent = 'x';
                removeSpan.onclick = () => removeGame(game.appid);
                pill.appendChild(removeSpan);
                selectedGamesContainer.appendChild(pill);
            });
        }

        function removeGame(appid) {
            selectedGames = selectedGames.filter(g => g.appid !== appid);
            renderSelectedGames();
        }

        // Salvar os jogos
        saveGamesButton.addEventListener('click', () => {
            const gamesArray = selectedGames.map(g => g.appid);
            fetch('/set-games', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ games: gamesArray })
            }).then(res => res.json()).then(data => {
                alert(data.message);
                gamesModal.style.display = 'none';
            });
        });
    </script>
</body>
</html>
