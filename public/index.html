<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - STF Steam Boost</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="control-panel">
        <header>
            <h1>STF Steam Boost</h1>
        </header>
        <div class="accounts-table">
            <table>
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Status</th>
                        <th>Iniciar/Parar</th>
                        <th>Steam Guard</th>
                        <th>Jogos</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="accountNameCell">Carregando...</td>
                        <td id="statusCell" class="status-stopped">Carregando...</td>
                        <td><button id="startStopButton" class="start-btn">Iniciar</button></td>
                        <td><button id="guardButton" class="enter-btn">Inserir</button></td>
                        <td><button id="manageGamesButton" class="manage-btn" disabled>Gerir</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="gamesModal" class="modal">
        <div class="modal-content">
            <h2>Gerir Jogos</h2>
            <p>Selecione os jogos que deseja impulsionar.</p>
            <div id="selectedGames"></div>
            <input type="text" id="searchInput" placeholder="Pesquisar jogos por nome...">
            <ul id="resultsList"></ul>
            <button id="saveGamesButton">Salvar</button>
            <button id="closeModalButton">Cancelar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da UI principal
            const startStopButton = document.getElementById('startStopButton');
            const guardButton = document.getElementById('guardButton');
            const manageGamesButton = document.getElementById('manageGamesButton');
            const statusCell = document.getElementById('statusCell');

            // Elementos da Modal
            const gamesModal = document.getElementById('gamesModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const searchInput = document.getElementById('searchInput');
            const resultsList = document.getElementById('resultsList');
            const selectedGamesContainer = document.getElementById('selectedGames');
            const saveGamesButton = document.getElementById('saveGamesButton');

            let selectedGames = [];

            async function updateUI() {
                try {
                    const response = await fetch('/status');
                    const state = await response.json();

                    document.getElementById('accountNameCell').textContent = state.accountName;
                    statusCell.textContent = state.status;
                    statusCell.className = '';

                    if (state.status === "Rodando") {
                        startStopButton.textContent = "Parar";
                        startStopButton.className = 'stop-btn';
                    } else {
                        startStopButton.textContent = "Iniciar";
                        startStopButton.className = 'start-btn';
                    }

                    guardButton.classList.remove('pulse-attention');
                    if (state.status === "Rodando") {
                        statusCell.classList.add('status-running');
                    } else if (state.status === "Parado") {
                        statusCell.classList.add('status-stopped');
                    } else {
                        statusCell.classList.add('status-pending');
                        if (state.status === "Pendente: Steam Guard") {
                            guardButton.classList.add('pulse-attention');
                        }
                    }

                    manageGamesButton.disabled = !state.appListReady;
                    manageGamesButton.title = state.appListReady ? "" : "Aguarde o carregamento da lista de jogos.";
                } catch (error) {
                    statusCell.textContent = "Erro de Conexão";
                    statusCell.className = 'status-error';
                }
            }

            startStopButton.addEventListener('click', () => {
                const action = startStopButton.textContent === 'Iniciar' ? '/start' : '/stop';
                fetch(action, { method: 'POST' }).finally(() => setTimeout(updateUI, 500));
            });

            guardButton.addEventListener('click', () => {
                const code = prompt('Por favor, insira o código do Steam Guard:');
                if (code) {
                    fetch('/submit-guard', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code })
                    }).finally(() => setTimeout(updateUI, 1000));
                }
            });

            // --- Lógica da Modal de Jogos ---

            manageGamesButton.addEventListener('click', async () => {
                const response = await fetch('/status');
                const state = await response.json();
                const appIds = state.games;
                
                // Para preencher os nomes, teríamos que buscar um por um, o que é lento.
                // Por enquanto, vamos manter a lógica simples de IDs e buscar ao selecionar.
                selectedGames = appIds.map(appid => ({ appid, name: `Jogo ${appid}` })); 
                renderSelectedGames();
                gamesModal.style.display = 'block';
            });

            const hideModal = () => gamesModal.style.display = 'none';
            closeModalButton.addEventListener('click', hideModal);
            window.addEventListener('click', (event) => {
                if (event.target == gamesModal) hideModal();
            });

            searchInput.addEventListener('input', async () => {
                const query = searchInput.value;
                resultsList.innerHTML = '';
                if (query.length < 2) return;
                
                const response = await fetch(`/search-games?q=${query}`);
                const games = await response.json();
                games.forEach(game => {
                    const li = document.createElement('li');
                    li.textContent = `${game.name} (${game.appid})`;
                    li.onclick = () => selectGame(game);
                    resultsList.appendChild(li);
                });
            });

            function selectGame(game) {
                if (!selectedGames.find(g => g.appid === game.appid)) {
                    selectedGames.push(game);
                    renderSelectedGames();
                }
                searchInput.value = '';
                resultsList.innerHTML = '';
            }

            function renderSelectedGames() {
                selectedGamesContainer.innerHTML = '';
                selectedGames.forEach(game => {
                    const pill = document.createElement('div');
                    pill.className = 'game-pill';
                    pill.textContent = game.name;
                    const removeSpan = document.createElement('span');
                    removeSpan.textContent = 'x';
                    removeSpan.onclick = () => removeGame(game.appid);
                    pill.appendChild(removeSpan);
                    selectedGamesContainer.appendChild(pill);
                });
            }

            function removeGame(appid) {
                selectedGames = selectedGames.filter(g => g.appid !== appid);
                renderSelectedGames();
            }

            saveGamesButton.addEventListener('click', () => {
                const gamesArray = selectedGames.map(g => g.appid);
                fetch('/set-games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ games: gamesArray })
                }).then(() => hideModal());
            });

            // Inicialização da UI
            updateUI();
            setInterval(updateUI, 3000);
        });
    </script>
</body>
</html>
